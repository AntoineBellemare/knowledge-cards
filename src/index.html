<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Knowledge Cards Studio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind config (retro-futurist palette) -->
  <script>
    tailwind = {
      theme: {
        extend: {
          fontFamily: {
            mono: ['"IBM Plex Mono"', 'ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', 'monospace'],
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
          colors: {
            bgDeep: '#050814',
            bgPanel: 'rgba(10, 13, 32, 0.95)',
            bgPanelSoft: 'rgba(15, 22, 55, 0.9)',
            accentCyan: '#2dd4ff',
            accentPurple: '#a855ff',
            accentPink: '#f973ff',
            borderSoft: 'rgba(148, 163, 184, 0.35)',
          },
          boxShadow: {
            neon: '0 0 18px rgba(45, 212, 255, 0.25)',
            neonSoft: '0 0 12px rgba(168, 85, 255, 0.25)',
          },
          backgroundImage: {
            grid: "radial-gradient(circle at 1px 1px, rgba(148, 163, 184, 0.15) 1px, transparent 0)",
          },
        },
      },
    };
  </script>

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: theme('fontFamily.sans');
      background:
        radial-gradient(circle at top left, rgba(45, 212, 255, 0.16), transparent 55%),
        radial-gradient(circle at bottom right, rgba(168, 85, 255, 0.18), transparent 55%),
        #020617;
      color: #e5e7eb;
    }

    .glass {
      background: linear-gradient(
        135deg,
        rgba(15, 23, 42, 0.92),
        rgba(15, 23, 42, 0.85)
      );
      border: 1px solid rgba(148, 163, 184, 0.35);
      backdrop-filter: blur(16px);
    }

    .glass-soft {
      background: linear-gradient(
        135deg,
        rgba(15, 23, 42, 0.88),
        rgba(15, 23, 42, 0.82)
      );
      border: 1px solid rgba(51, 65, 85, 0.7);
      backdrop-filter: blur(12px);
    }

    .cyber-border {
      border-image: linear-gradient(
        to bottom,
        rgba(45, 212, 255, 0.9),
        rgba(168, 85, 255, 0.7)
      ) 1;
    }

    .glow-ring {
      box-shadow:
        0 0 0 1px rgba(148, 163, 184, 0.2),
        0 0 20px rgba(45, 212, 255, 0.24);
    }

    .neon-pill {
      background: radial-gradient(circle at 0% 0%, rgba(45, 212, 255, 0.35), transparent 60%),
                  linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.85));
      border: 1px solid rgba(56, 189, 248, 0.6);
    }

    .nav-active {
      background: linear-gradient(90deg, rgba(45, 212, 255, 0.24), transparent);
      border-left: 2px solid rgba(45, 212, 255, 0.95);
      color: #e5e7eb;
      box-shadow: 0 0 18px rgba(45, 212, 255, 0.2);
    }

    .nav-idle {
      color: #9ca3af;
    }

    .nav-idle:hover {
      background: linear-gradient(90deg, rgba(15, 23, 42, 0.9), transparent);
      color: #e5e7eb;
    }

    .code-chip {
      border-radius: 9999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: radial-gradient(circle at 0 0, rgba(45, 212, 255, 0.4), transparent 60%);
    }
  </style>
</head>
<body class="h-screen w-screen flex">

  <!-- Sidebar -->
  <aside class="w-72 glass flex flex-col shadow-neon">
    <div class="px-5 py-4 border-b borderSoft flex items-center justify-between">
      <div>
        <div class="font-mono text-sm tracking-[0.18em] uppercase text-slate-300">
          // Studio
        </div>
        <div class="mt-1 text-lg font-mono tracking-tight">
          <span class="text-accentCyan">Knowledge</span>
          <span class="text-slate-100">Cards</span>
        </div>
      </div>
      <div class="code-chip px-2.5 py-1 text-[0.65rem] font-mono text-slate-50 shadow-neonSoft">
        TS ‚Ä¢ R∆í
      </div>
    </div>

    <nav class="flex-1 px-3 py-4 text-[0.8rem] space-y-1">
      <button id="nav-welcome"
        class="w-full text-left px-3 py-2.5 rounded-md nav-active flex items-center gap-2 font-mono text-xs transition-all">
        <span class="text-accentCyan">‚ú¶</span>
        <span>Welcome</span>
      </button>
      <button id="nav-question"
        class="w-full text-left px-3 py-2.5 rounded-md nav-idle flex items-center gap-2 font-mono text-xs transition-all">
        <span class="text-slate-500">‚ñÆ</span>
        <span>New template from question</span>
      </button>
      <button id="nav-templates"
        class="w-full text-left px-3 py-2.5 rounded-md nav-idle flex items-center gap-2 font-mono text-xs transition-all">
        <span class="text-slate-500">‚ñØ</span>
        <span>Template library</span>
      </button>
      <button id="nav-runs"
        class="w-full text-left px-3 py-2.5 rounded-md nav-idle flex items-center gap-2 font-mono text-xs transition-all">
        <span class="text-slate-500">‚óé</span>
        <span>Runs / reports</span>
      </button>
      <button id="nav-editor"
        class="w-full text-left px-3 py-2.5 rounded-md nav-idle flex items-center gap-2 font-mono text-xs transition-all hidden">
        <span class="text-slate-500">‚úé</span>
        <span>Edit current template</span>
      </button>
    </nav>

    <div class="px-5 py-3 border-t borderSoft text-[0.65rem] text-slate-500 font-mono">
      <div class="flex items-center justify-between">
        <span>backend: offline mock</span>
        <span class="text-accentPurple">v0.1</span>
      </div>
    </div>
  </aside>

  <!-- Main content -->
  <main class="flex-1 overflow-hidden px-4 py-4">
    <div class="h-full w-full glass-soft rounded-xl shadow-neonSoft border cyber-border bg-grid bg-[size:20px_20px] overflow-auto flex flex-col">

      <!-- Top bar -->
      <header class="px-6 py-3 border-b borderSoft flex items-center justify-between">
        <div>
          <div class="font-mono text-[0.7rem] tracking-[0.2em] uppercase text-slate-400">
            Gemini ‚Ä¢ schema ‚Ä¢ cards
          </div>
          <div class="mt-0.5 text-sm text-slate-300">
            Design templates, then run synthesis pipelines over your PDFs.
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button
            class="neon-pill px-3 py-1.5 text-[0.7rem] font-mono text-slate-50 flex items-center gap-1 shadow-neon">
            <span class="text-accentCyan">‚óè</span>
            <span>connected</span>
          </button>
        </div>
      </header>

      <!-- View: Welcome -->
      <section id="view-welcome" class="flex-1 overflow-auto">
        <div class="max-w-5xl mx-auto py-8 px-6">
          
          <!-- Hero Section -->
          <div class="grid lg:grid-cols-2 gap-10 items-center mb-16">
            <div class="space-y-6">
              <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-mono bg-slate-800/50 border border-slate-700 text-slate-400">
                <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
                Powered by Gemini AI
              </div>
              
              <h1 class="text-4xl lg:text-5xl font-bold leading-tight">
                Transform Papers into
                <span style="background: linear-gradient(135deg, #2dd4ff, #a855ff, #f973ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"> Structured Insights</span>
              </h1>
              
              <p class="text-lg text-slate-400 leading-relaxed">
                A schema-agnostic LLM pipeline that transforms scientific litterature into structured JSON knowledge cards. Design your own knowledge templates, process PDFs, and generate beautiful reports.
              </p>
              
              <div class="flex items-center gap-4">
                <button onclick="setView('question')" class="group px-5 py-2.5 rounded-lg font-medium text-sm text-white shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-200" style="background: linear-gradient(90deg, #2dd4ff, #a855ff, #f973ff);">
                  <span class="flex items-center gap-2">
                    Get Started
                    <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                    </svg>
                  </span>
                </button>
                <a href="https://github.com/AntoineBellemare/knowledge-cards" target="_blank" class="px-5 py-2.5 rounded-lg font-medium text-sm border border-slate-600 text-slate-300 hover:bg-slate-800 hover:border-slate-500 transition-all flex items-center gap-2">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                  </svg>
                  GitHub
                </a>
              </div>
            </div>
            
            <div class="relative">
              <div class="absolute inset-0 rounded-2xl blur-3xl" style="background: linear-gradient(135deg, rgba(45, 212, 255, 0.2), rgba(168, 85, 255, 0.2));"></div>
              <img 
                src="../assets/cover.png" 
                alt="Knowledge Cards Preview" 
                class="relative rounded-2xl shadow-2xl border border-slate-700/50"
                style="mask-image: linear-gradient(to bottom, black 70%, transparent 100%); -webkit-mask-image: linear-gradient(to bottom, black 70%, transparent 100%);"
              />
            </div>
          </div>

          <!-- Features Section -->
          <div class="mb-16">
            <div class="text-center mb-10">
              <h2 class="text-2xl font-bold mb-3">Powerful Features</h2>
              <p class="text-slate-400">Everything you need to distill structured knowledge from your research papers.</p>
            </div>
            
            <div class="grid md:grid-cols-3 gap-4">
              <div class="glass-soft rounded-xl p-5 hover:scale-[1.02] transition-transform">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center mb-3" style="background: linear-gradient(135deg, rgba(45, 212, 255, 0.2), rgba(168, 85, 255, 0.2)); border: 1px solid rgba(45, 212, 255, 0.3);">
                  <svg class="w-5 h-5" style="color: #2dd4ff;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                </div>
                <h3 class="font-semibold mb-1">Schema-Agnostic</h3>
                <p class="text-slate-400 text-sm">Design your own knowledge templates. Define exactly what information you want to pull.</p>
              </div>

              <div class="glass-soft rounded-xl p-5 hover:scale-[1.02] transition-transform">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center mb-3" style="background: linear-gradient(135deg, rgba(168, 85, 255, 0.2), rgba(249, 115, 255, 0.2)); border: 1px solid rgba(168, 85, 255, 0.3);">
                  <svg class="w-5 h-5" style="color: #a855ff;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                  </svg>
                </div>
                <h3 class="font-semibold mb-1">AI-Powered Synthesis</h3>
                <p class="text-slate-400 text-sm">Leverage Google Gemini to intelligently reveal and structure information.</p>
              </div>

              <div class="glass-soft rounded-xl p-5 hover:scale-[1.02] transition-transform">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center mb-3" style="background: linear-gradient(135deg, rgba(249, 115, 255, 0.2), rgba(45, 212, 255, 0.2)); border: 1px solid rgba(249, 115, 255, 0.3);">
                  <svg class="w-5 h-5" style="color: #f973ff;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                </div>
                <h3 class="font-semibold mb-1">Beautiful Reports</h3>
                <p class="text-slate-400 text-sm">Generate professional PDF reports with structured cards for each paper.</p>
              </div>

              <div class="glass-soft rounded-xl p-5 hover:scale-[1.02] transition-transform">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center mb-3" style="background: linear-gradient(135deg, rgba(45, 212, 255, 0.2), rgba(168, 85, 255, 0.2)); border: 1px solid rgba(45, 212, 255, 0.3);">
                  <svg class="w-5 h-5" style="color: #2dd4ff;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
                  </svg>
                </div>
                <h3 class="font-semibold mb-1">Multiple Outputs</h3>
                <p class="text-slate-400 text-sm">Export to JSONL, CSV, and PDF formats for analysis or sharing.</p>
              </div>

              <div class="glass-soft rounded-xl p-5 hover:scale-[1.02] transition-transform">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center mb-3" style="background: linear-gradient(135deg, rgba(168, 85, 255, 0.2), rgba(249, 115, 255, 0.2)); border: 1px solid rgba(168, 85, 255, 0.3);">
                  <svg class="w-5 h-5" style="color: #a855ff;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z"/>
                  </svg>
                </div>
                <h3 class="font-semibold mb-1">Meta-Card Synthesis</h3>
                <p class="text-slate-400 text-sm">Automatically generate a synthesized overview combining all papers.</p>
              </div>

              <div class="glass-soft rounded-xl p-5 hover:scale-[1.02] transition-transform">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center mb-3" style="background: linear-gradient(135deg, rgba(249, 115, 255, 0.2), rgba(45, 212, 255, 0.2)); border: 1px solid rgba(249, 115, 255, 0.3);">
                  <svg class="w-5 h-5" style="color: #f973ff;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
                  </svg>
                </div>
                <h3 class="font-semibold mb-1">Real-time Progress</h3>
                <p class="text-slate-400 text-sm">Watch your cards being built with live progress updates.</p>
              </div>
            </div>
          </div>

          <!-- How it Works Section -->
          <div class="mb-10">
            <div class="text-center mb-10">
              <h2 class="text-2xl font-bold mb-3">How It Works</h2>
              <p class="text-slate-400">Three simple steps to structured knowledge</p>
            </div>
            
            <div class="space-y-6">
              <div class="flex gap-5 items-start">
                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center">
                  <span class="text-xl font-bold" style="background: linear-gradient(135deg, #2dd4ff, #a855ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">1</span>
                </div>
                <div class="flex-1 glass-soft rounded-xl p-5">
                  <h3 class="font-semibold mb-2">Design Your Template</h3>
                  <p class="text-slate-400 text-sm mb-3">Ask a research question, and let AI generate a structured schema ‚Äî or create your own custom template with exactly the fields you need.</p>
                  <div class="rounded-lg p-3 font-mono text-xs bg-black/30 border border-slate-700">
                    <span class="text-slate-500">// Example question:</span><br>
                    <span style="color: #2dd4ff;">"How does network dynamics change across biological lifeforms?"</span>
                  </div>
                </div>
              </div>

              <div class="flex gap-5 items-start">
                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center">
                  <span class="text-xl font-bold" style="background: linear-gradient(135deg, #2dd4ff, #a855ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">2</span>
                </div>
                <div class="flex-1 glass-soft rounded-xl p-5">
                  <h3 class="font-semibold mb-2">Add Your Papers</h3>
                  <p class="text-slate-400 text-sm mb-3">Drop your PDF research papers into a folder. The pipeline handles text ingestion, chunking, and intelligent processing automatically.</p>
                  <div class="rounded-lg p-3 font-mono text-xs bg-black/30 border border-slate-700 text-slate-400">
                    papers/<br>
                    ‚îî‚îÄ‚îÄ plant_cognition/<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;‚îú‚îÄ‚îÄ paper1.pdf<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;‚îú‚îÄ‚îÄ paper2.pdf<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;‚îî‚îÄ‚îÄ paper3.pdf
                  </div>
                </div>
              </div>

              <div class="flex gap-5 items-start">
                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center">
                  <span class="text-xl font-bold" style="background: linear-gradient(135deg, #2dd4ff, #a855ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">3</span>
                </div>
                <div class="flex-1 glass-soft rounded-xl p-5">
                  <h3 class="font-semibold mb-2">Build Your Cards</h3>
                  <p class="text-slate-400 text-sm mb-3">Click "Build Cards" and watch the magic happen. Get individual cards for each paper, plus a synthesized meta-card combining all insights.</p>
                  <div class="flex flex-wrap gap-2 mt-3">
                    <span class="px-2.5 py-1 rounded-full text-xs font-mono bg-slate-800 border border-slate-700">üìÑ cards.jsonl</span>
                    <span class="px-2.5 py-1 rounded-full text-xs font-mono bg-slate-800 border border-slate-700">üìä summary.csv</span>
                    <span class="px-2.5 py-1 rounded-full text-xs font-mono bg-slate-800 border border-slate-700">üìë report.pdf</span>
                    <span class="px-2.5 py-1 rounded-full text-xs font-mono bg-slate-800 border border-slate-700">üß† meta-card.pdf</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- CTA -->
          <div class="text-center glass-soft rounded-2xl p-8 relative overflow-hidden">
            <div class="absolute inset-0" style="background: linear-gradient(135deg, rgba(45, 212, 255, 0.05), rgba(168, 85, 255, 0.05), rgba(249, 115, 255, 0.05));"></div>
            <div class="relative">
              <h2 class="text-2xl font-bold mb-3">Ready to Transform Your Research?</h2>
              <p class="text-slate-400 mb-6">Start uncovering structured insights from your papers today.</p>
              <button onclick="setView('question')" class="inline-flex items-center gap-2 px-6 py-3 rounded-xl font-semibold text-white shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-200" style="background: linear-gradient(90deg, #2dd4ff, #a855ff, #f973ff);">
                Start Building Cards
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                </svg>
              </button>
            </div>
          </div>

          <!-- Footer -->
          <div class="mt-10 pt-6 border-t border-slate-800 flex items-center justify-between text-sm text-slate-500">
            <span>Built with üíú by Antoine Bellemare</span>
            <a href="https://github.com/AntoineBellemare/knowledge-cards" target="_blank" class="hover:text-white transition-colors flex items-center gap-1">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
              </svg>
              GitHub
            </a>
          </div>
        </div>
      </section>

      <!-- View: Question -->
      <section id="view-question" class="flex-1 overflow-auto hidden">
        <div class="max-w-4xl mx-auto py-7 px-6">
          <h1 class="text-2xl font-semibold text-slate-100 tracking-tight mb-1">
            New template from question
          </h1>
          <p class="text-sm text-slate-400 mb-5 max-w-2xl">
            Ask a high-level question. The system will synthesize a structured card template
            to annotate and compare papers that speak to that question.
          </p>

          <label class="block text-xs font-mono tracking-wide text-slate-400 mb-1">
            QUESTION
          </label>
          <div class="rounded-lg glow-ring bg-slate-950/60">
            <textarea id="question-input"
              class="w-full bg-transparent rounded-lg px-3 py-3 text-sm text-slate-100 focus:outline-none font-mono"
              rows="4">how does network dynamics change across biological lifeforms</textarea>
          </div>

          <div class="mt-5 grid grid-cols-2 gap-3 text-[0.75rem]">
            <label class="flex items-center gap-2 text-slate-300">
              <input type="checkbox" id="opt-conceptual" checked
                class="rounded border-slate-500 bg-slate-900/60" />
              <span>Emphasize conceptual / philosophical aspects</span>
            </label>
            <label class="flex items-center gap-2 text-slate-300">
              <input type="checkbox" id="opt-empirical" checked
                class="rounded border-slate-500 bg-slate-900/60" />
              <span>Include empirical / methods structure</span>
            </label>
            <label class="flex items-center gap-2 text-slate-300">
              <input type="checkbox" id="opt-metapoetic"
                class="rounded border-slate-500 bg-slate-900/60" />
              <span>Include metaphysical / poetic dimensions</span>
            </label>
            <label class="flex items-center gap-2 text-slate-300">
              <input type="checkbox" id="opt-ethics"
                class="rounded border-slate-500 bg-slate-900/60" />
              <span>Include ethics / community / context</span>
            </label>
          </div>

          <div class="mt-7 flex items-center gap-4">
            <button id="btn-generate"
                class="inline-flex items-center px-4 py-2.5 rounded-md bg-[#f8f8f4] text-slate-900 text-xs font-mono tracking-wide shadow-neon hover:brightness-95 transition-all">
                <span class="mr-1">‚ö°</span>
                <span>Generate template</span>
            </button>
            <button id="btn-open-current-from-question"
              class="text-xs font-mono text-accentCyan hover:underline hidden">
              ‚á¢ Open current template
            </button>
          </div>

          <div id="question-status" class="mt-3 text-[0.7rem] font-mono text-slate-400"></div>
        </div>
      </section>

      <!-- View: Templates -->
      <section id="view-templates" class="flex-1 overflow-auto hidden">
        <div class="max-w-5xl mx-auto py-7 px-6">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h1 class="text-2xl font-semibold text-slate-100 tracking-tight">
                Template library
              </h1>
              <p class="text-xs text-slate-400">
                Saved schemas for different questions and projects.
              </p>
            </div>
            <button id="btn-open-current-from-library"
              class="text-xs font-mono text-accentCyan hover:underline hidden">
              ‚á¢ Edit current template
            </button>
          </div>

          <div id="templates-empty" class="text-sm text-slate-400">
            No templates saved yet. Generate a template from a question, then click
            <span class="font-mono text-accentCyan text-white">Save to library</span> in the editor.
          </div>

          <div id="templates-list" class="space-y-3 hidden"></div>
        </div>
      </section>

      <!-- View: Runs -->
    <section id="view-runs" class="flex-1 overflow-auto hidden">
    <div class="max-w-3xl mx-auto py-7 px-6 space-y-5">
        <div>
        <h1 class="text-2xl font-semibold text-slate-100 mb-1">
            Runs &amp; reports
        </h1>
        <p class="text-sm text-slate-400">
            Pick a card template (schema) and a folder of PDFs under
            <span class="font-mono text-accentCyan">papers/</span>, then run the
            Gemini pipeline. Outputs are written to
            <span class="font-mono text-accentCyan">results/</span>.
        </p>
        </div>

        <div class="glass-soft rounded-lg border borderSoft p-4 space-y-4">
        <div class="grid grid-cols-1 gap-4">
            <div>
            <label class="block text-xs font-mono text-slate-400 mb-1">
                CARD TEMPLATE (schema in <span class="font-mono">cards/</span>)
            </label>
            <select id="run-schema"
                class="w-full bg-slate-950/70 border borderSoft rounded-md px-2 py-2 text-xs font-mono text-slate-100">
                <option value="">‚Äî select schema ‚Äî</option>
            </select>
            </div>

            <div>
            <label class="block text-xs font-mono text-slate-400 mb-1">
                PAPERS FOLDER (subfolder in <span class="font-mono">papers/</span>)
            </label>
            <select id="run-folder"
                class="w-full bg-slate-950/70 border borderSoft rounded-md px-2 py-2 text-xs font-mono text-slate-100">
                <option value="">‚Äî select folder ‚Äî</option>
            </select>
            </div>
        </div>

        <div class="flex flex-col gap-4">
            <button id="btn-run-gemini"
              class="group relative px-6 py-3 rounded-lg bg-gradient-to-r from-accentCyan via-accentPurple to-accentPink text-white text-sm font-semibold shadow-neon hover:shadow-lg hover:scale-[1.02] transition-all duration-200 overflow-hidden">
              <span class="relative z-10 flex items-center justify-center gap-2">
                <svg id="btn-icon-default" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                </svg>
                <svg id="btn-icon-loading" class="w-5 h-5 animate-spin hidden" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="btn-text">Build Cards</span>
              </span>
              <div class="absolute inset-0 bg-gradient-to-r from-white/0 via-white/20 to-white/0 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"></div>
            </button>
            
            <!-- Progress bar -->
            <div id="progress-container" class="hidden">
              <div class="flex justify-between text-xs text-slate-400 mb-1">
                <span id="progress-label">Initializing...</span>
                <span id="progress-percent">0%</span>
              </div>
              <div class="h-3 bg-slate-800 rounded-full overflow-hidden shadow-inner">
                <div id="progress-bar" class="h-full rounded-full transition-all duration-300 ease-out" style="width: 0%; background: linear-gradient(90deg, #2dd4ff, #a855ff, #f973ff);"></div>
              </div>
            </div>
            
            <span id="run-status" class="text-xs font-mono text-slate-400"></span>
        </div>

        <div id="run-output" class="text-[0.75rem] font-mono text-slate-300"></div>
        </div>
    </div>
    </section>


      <!-- View: Editor -->
      <section id="view-editor" class="flex-1 flex flex-col hidden">
        <div
          class="px-6 py-3 border-b borderSoft flex items-center justify-between bg-slate-950/50">
          <div class="flex items-center gap-3">
            <input id="template-name"
              class="text-sm font-mono text-accentCyan border-none focus:outline-none bg-transparent px-0 py-0"
              value="template_name" />
            <span id="template-meta"
              class="text-[0.65rem] font-mono text-slate-500"></span>
          </div>
          <div class="flex items-center gap-3 text-[0.7rem] font-mono">
            <label class="flex items-center gap-1 text-slate-400">
              <input type="checkbox" id="toggle-full-json"
                class="rounded border-slate-500 bg-slate-900/60" />
              <span>Full JSON</span>
            </label>
            <button id="btn-save-template"
              class="px-3 py-1.5 rounded-md bg-gradient-to-r from-accentPurple to-accentCyan text-slate-50 hover:brightness-110 shadow-neon text-xs">
              Save to library
            </button>
          </div>
        </div>

        <div class="flex-1 overflow-auto px-6 py-4">
          <div id="editor-sections"
            class="grid grid-cols-1 lg:grid-cols-2 gap-4 pr-2 pb-8">
            <!-- injected -->
            </div>


          <div id="full-json-container" class="mt-6 hidden">
            <h2 class="text-xs font-mono text-slate-300 mb-1">
              FULL SCHEMA JSON
            </h2>
            <pre id="full-json"
              class="text-[0.7rem] font-mono bg-slate-950 text-slate-100 rounded-lg p-3 overflow-auto max-h-[320px] border borderSoft"></pre>
          </div>
        </div>
      </section>

    </div>
  </main>

    <script>
    // ----- Global state -----
    let currentView = "question";
    let templates = [];
    let currentTemplate = null; // {id, name, question, createdAt, schema}
    let schemaJSON = null;
    let sectionExpanded = {}; // key -> bool
    let showFullJSON = false;

    // Auto-detect API base URL: use localhost for local dev (including file://), or production URL
    const isLocal = !window.location.hostname || window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1";
    const API_BASE = isLocal
      ? "http://localhost:8000"
      : "https://knowledge-cards-api.up.railway.app";  // <- Update this with your Railway URL
    
    console.log("[DEBUG] hostname:", window.location.hostname, "| isLocal:", isLocal, "| API_BASE:", API_BASE);

    // ----- DOM helpers -----
    function $(id) {
      return document.getElementById(id);
    }

    function setView(view) {
      currentView = view;
      ["view-welcome", "view-question", "view-templates", "view-runs", "view-editor"].forEach(
        (vid) => {
          $(vid).classList.toggle("hidden", vid !== "view-" + view);
        }
      );

      const mapping = {
        welcome: "nav-welcome",
        question: "nav-question",
        templates: "nav-templates",
        runs: "nav-runs",
        editor: "nav-editor",
      };

      Object.keys(mapping).forEach((v) => {
        const btn = $(mapping[v]);
        if (!btn) return;
        if (v === view) {
          btn.classList.add("nav-active");
          btn.classList.remove("nav-idle");
        } else {
          btn.classList.remove("nav-active");
          if (v !== "editor" || currentTemplate) {
            btn.classList.add("nav-idle");
          }
        }
      });

      if (view === "templates") renderTemplatesView();
      if (view === "editor") renderEditorView();
    }

    function prettyDate(iso) {
      return new Date(iso).toLocaleString();
    }

    function downloadJSON(filename, data) {
      const blob = new Blob([JSON.stringify(data, null, 2)], {
        type: "application/json",
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ---------- Backend helpers ----------

    async function apiGenerateSchemaFromQuestion(question, pointers) {
      console.log("[api] generate schema for question:", question, pointers);

      const response = await fetch(`${API_BASE}/schema_from_question`, {
        method: "POST",
        mode: "cors",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          question,
          pointers: {
            emphasize_conceptual: !!pointers.conceptual,
            include_empirical_methods: !!pointers.empirical,
            include_metaphysical_and_poetic: !!pointers.metapoetic,
            include_ethics_context: !!pointers.ethics,
          },
        }),
      });

      if (!response.ok) {
        const text = await response.text();
        console.error("API error:", response.status, text);
        throw new Error(`API error ${response.status}: ${text}`);
      }

      const data = await response.json();
      return data.schema; // schema object
    }

    async function apiSaveSchema(name, schema) {
      const res = await fetch(`${API_BASE}/save_schema`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, schema }),
      });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(`Save schema error ${res.status}: ${text}`);
      }
      return res.json(); // {ok, filename}
    }

    async function apiListSchemas() {
      const res = await fetch(`${API_BASE}/schemas`);
      if (!res.ok) throw new Error("Failed to list schemas");
      return res.json(); // {schemas: [...]}
    }

    async function apiListPapersFolders() {
      const res = await fetch(`${API_BASE}/papers_folders`);
      if (!res.ok) throw new Error("Failed to list papers folders");
      return res.json(); // {folders: [...]}
    }

    async function apiRunGemini(schemaName, papersSubdir) {
      const res = await fetch(`${API_BASE}/run_gemini`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          schema_name: schemaName,
          papers_subdir: papersSubdir,
        }),
      });
      const data = await res.json();
      if (!res.ok) {
        throw new Error(data.detail || "Failed to run Gemini");
      }
      return data; // {ok, jsonl, csv}
    }

    // SSE-based streaming API for real-time progress
    function apiRunGeminiWithProgress(schemaName, papersSubdir, onProgress) {
      return new Promise((resolve, reject) => {
        const url = `${API_BASE}/run_gemini_stream?schema_name=${encodeURIComponent(schemaName)}&papers_subdir=${encodeURIComponent(papersSubdir)}`;
        const eventSource = new EventSource(url);
        
        eventSource.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            
            if (data.type === 'keepalive') {
              return; // Ignore keepalives
            }
            
            if (data.type === 'error') {
              eventSource.close();
              reject(new Error(data.message));
              return;
            }
            
            if (data.type === 'complete') {
              eventSource.close();
              resolve({
                ok: true,
                schema_name: data.schema_name,
                papers_folder: data.papers_folder,
                jsonl: data.jsonl,
                csv: data.csv,
                pdf: data.pdf,
              });
              return;
            }
            
            // Progress update
            if (onProgress) {
              onProgress(data);
            }
          } catch (e) {
            console.error("Error parsing SSE data:", e);
          }
        };
        
        eventSource.onerror = (err) => {
          eventSource.close();
          reject(new Error("Connection to server lost"));
        };
      });
    }

    async function loadTemplatesFromBackend() {
      const res = await fetch(`${API_BASE}/list_templates`);
      if (!res.ok) return;
      const data = await res.json();
      templates = data.templates || [];
    }

    // ----- Question view logic -----
    let generating = false;

    async function handleGenerateTemplate() {
      if (generating) return;
      const q = $("question-input").value.trim();
      if (!q) return;

      generating = true;
      $("btn-generate").textContent = "Generating template‚Ä¶";
      $("btn-generate").classList.add("opacity-60", "cursor-wait");
      $("question-status").textContent = "Calling backend‚Ä¶";

      const options = {
        conceptual: $("opt-conceptual").checked,
        empirical: $("opt-empirical").checked,
        metapoetic: $("opt-metapoetic").checked,
        ethics: $("opt-ethics").checked,
      };

      try {
        const schema = await apiGenerateSchemaFromQuestion(q, options);
        schemaJSON = schema;
        sectionExpanded = {};
        showFullJSON = false;
        const now = new Date().toISOString();

        currentTemplate = {
          id: "tmp_" + Date.now(),
          name: "new_template_from_question",
          createdAt: now,
          question: q,
          schema: schema,
        };

        $("nav-editor").classList.remove("hidden");
        $("btn-open-current-from-question").classList.remove("hidden");
        $("btn-open-current-from-library").classList.remove("hidden");

        $("question-status").textContent = "Template generated. Opening editor‚Ä¶";
        setView("editor");
      } catch (err) {
        console.error(err);
        $("question-status").textContent =
          "Error generating template (see console).";
      }

      generating = false;
      $("btn-generate").textContent = "Generate template";
      $("btn-generate").classList.remove("opacity-60", "cursor-wait");
    }

    // ----- Templates library view -----
    function renderTemplatesView() {
      const listEl = $("templates-list");
      const emptyEl = $("templates-empty");

      if (!templates.length) {
        emptyEl.classList.remove("hidden");
        listEl.classList.add("hidden");
        listEl.innerHTML = "";
        return;
      }

      emptyEl.classList.add("hidden");
      listEl.classList.remove("hidden");
      listEl.innerHTML = "";

      templates.forEach((t) => {
        const card = document.createElement("div");
        card.className =
          "glass-soft border borderSoft rounded-lg px-4 py-3 flex items-start justify-between gap-4";

        const left = document.createElement("div");
        const nameDiv = document.createElement("div");
        nameDiv.className = "text-sm font-mono text-accentCyan";
        nameDiv.textContent = t.name;
        left.appendChild(nameDiv);

        const dateDiv = document.createElement("div");
        dateDiv.className = "text-[0.65rem] font-mono text-slate-500";
        dateDiv.textContent = "created: " + prettyDate(t.createdAt);
        left.appendChild(dateDiv);

        if (t.question) {
          const qDiv = document.createElement("div");
          qDiv.className = "mt-1 text-[0.7rem] text-slate-300 line-clamp-2";
          qDiv.innerHTML =
            "<span class='font-mono text-slate-400'>Q:</span> " + t.question;
          left.appendChild(qDiv);
        }

        const right = document.createElement("div");
        right.className =
          "flex flex-col items-end gap-1.5 text-[0.7rem] font-mono";

        const btnOpen = document.createElement("button");
        btnOpen.className =
          "px-2.5 py-1 rounded-md bg-slate-900 text-slate-100 border borderSoft hover:bg-slate-800";
        btnOpen.textContent = "Open";
        btnOpen.onclick = () => {
          currentTemplate = { ...t };
          schemaJSON = structuredClone(t.schema);
          sectionExpanded = {};
          showFullJSON = false;
          $("nav-editor").classList.remove("hidden");
          $("btn-open-current-from-question").classList.remove("hidden");
          $("btn-open-current-from-library").classList.remove("hidden");
          setView("editor");
        };
        right.appendChild(btnOpen);

        const btnDup = document.createElement("button");
        btnDup.className =
          "px-2.5 py-1 rounded-md border borderSoft hover:bg-slate-900 text-slate-200";
        btnDup.textContent = "Duplicate";
        btnDup.onclick = () => {
          const copy = {
            ...t,
            id: "tmp_" + Date.now(),
            name: t.name + "_copy",
            createdAt: new Date().toISOString(),
          };
          templates.push(copy);
          renderTemplatesView();
        };
        right.appendChild(btnDup);

        const btnExport = document.createElement("button");
        btnExport.className =
          "px-2.5 py-1 rounded-md border borderSoft hover:bg-slate-900 text-slate-200";
        btnExport.textContent = "Export JSON";
        btnExport.onclick = () =>
          downloadJSON((t.name || "template") + ".json", t.schema);
        right.appendChild(btnExport);

        card.appendChild(left);
        card.appendChild(right);
        listEl.appendChild(card);
      });
    }

    async function saveCurrentTemplate() {
      if (!currentTemplate || !schemaJSON) return;

      const nameInput = $("template-name");
      const name =
        nameInput.value.trim() ||
        currentTemplate.name ||
        "unnamed_template_" + Date.now();

      const existingIdx = templates.findIndex((t) => t.id === currentTemplate.id);
      const updated = {
        ...currentTemplate,
        name,
        schema: schemaJSON,
        createdAt: currentTemplate.createdAt || new Date().toISOString(),
      };

      if (existingIdx >= 0) {
        templates[existingIdx] = updated;
      } else {
        templates.push(updated);
      }
      currentTemplate = updated;

      try {
        const resp = await apiSaveSchema(name, schemaJSON);
        console.log("Schema saved as", resp.filename);
        alert(`Template saved and written to cards/${resp.filename}`);
      } catch (err) {
        console.error(err);
        alert(
          "Template saved locally, but failed to write to cards/ (see console)."
        );
      }

      renderTemplatesView();
    }

    // ----- Editor view -----
    function renderEditorView() {
      if (!currentTemplate || !schemaJSON) {
        $("editor-sections").innerHTML = `
          <div class="max-w-3xl mx-auto py-8">
            <h1 class="text-xl font-semibold text-slate-100 mb-2">
              Template editor
            </h1>
            <p class="text-sm text-slate-400">
              No template selected. Generate one from a question,
              or open one from the library.
            </p>
          </div>`;
        return;
      }

      $("template-name").value = currentTemplate.name || "template_name";
      $("template-meta").textContent =
        "(created " + prettyDate(currentTemplate.createdAt) + ")";
      $("toggle-full-json").checked = showFullJSON;

      const container = $("editor-sections");
      container.innerHTML = "";

      const topKeys = Object.keys(schemaJSON);

      topKeys.forEach((key) => {
        const value = schemaJSON[key];
        const isObject =
          value && typeof value === "object" && !Array.isArray(value);

        if (!sectionExpanded.hasOwnProperty(key)) {
          sectionExpanded[key] = true;
        }

        const card = document.createElement("div");
        card.className =
          "glass-soft border borderSoft rounded-lg flex flex-col";

        const header = document.createElement("button");
        header.type = "button";
        header.className =
          "px-3 py-2.5 border-b borderSoft flex items-center justify-between text-xs font-mono text-slate-200";

        const label = key.replace(/_/g, " ");
        const labelSpan = document.createElement("span");
        labelSpan.textContent = label;
        header.appendChild(labelSpan);

        const toggleSpan = document.createElement("span");
        toggleSpan.className = "text-[0.65rem] text-slate-400";
        toggleSpan.textContent = sectionExpanded[key] ? "Hide" : "Show";
        header.appendChild(toggleSpan);

        header.onclick = () => {
          sectionExpanded[key] = !sectionExpanded[key];
          renderEditorView();
        };

        card.appendChild(header);

        if (sectionExpanded[key]) {
          const body = document.createElement("div");
          body.className =
            "p-3 max-h-[400px] overflow-y-auto overflow-x-hidden rounded-b-lg";

          if (isObject) {
            const info = document.createElement("div");
            info.className =
              "text-[0.65rem] font-mono text-slate-400 mb-1";
            info.textContent = "Edit JSON for this section:";
            body.appendChild(info);

            const textarea = document.createElement("textarea");
            textarea.className =
              "w-full text-[0.7rem] font-mono border borderSoft rounded-md px-2 py-1 bg-slate-950 text-slate-100 min-h-[150px] focus:outline-none focus:ring-1 focus:ring-accentCyan";
            textarea.value = JSON.stringify(value, null, 2);

            textarea.onblur = () => {
              try {
                const parsed = JSON.parse(textarea.value);
                schemaJSON[key] = parsed;
                $("full-json").textContent = JSON.stringify(
                  schemaJSON,
                  null,
                  2
                );
              } catch (err) {
                console.warn("Invalid JSON for section", key, err);
                alert("Invalid JSON in section: " + key);
              }
            };

            body.appendChild(textarea);
          } else {
            const info = document.createElement("div");
            info.className = "text-[0.7rem] text-slate-300";
            info.textContent =
              "Non-object value (type: " +
              typeof value +
              "). Edit via full JSON view.";
            body.appendChild(info);
          }

          card.appendChild(body);
        }

        container.appendChild(card);
      });

      if (showFullJSON) {
        $("full-json-container").classList.remove("hidden");
        $("full-json").textContent = JSON.stringify(schemaJSON, null, 2);
      } else {
        $("full-json-container").classList.add("hidden");
      }
    }

    // ----- Runs & reports -----
    async function refreshRunOptions() {
      try {
        const [schemasRes, foldersRes] = await Promise.all([
          apiListSchemas(),
          apiListPapersFolders(),
        ]);

        const schemaSelect = $("run-schema");
        const folderSelect = $("run-folder");

        // clear, keep first placeholder option
        schemaSelect.options.length = 1;
        folderSelect.options.length = 1;

        schemasRes.schemas.forEach((name) => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          schemaSelect.appendChild(opt);
        });

        foldersRes.folders.forEach((folder) => {
          const opt = document.createElement("option");
          opt.value = folder;
          opt.textContent = folder;
          folderSelect.appendChild(opt);
        });
      } catch (err) {
        console.error("Failed to refresh run options", err);
        $("run-status").textContent =
          "Error loading schemas/folders (see console).";
      }
    }

    async function handleRunGemini() {
        const schemaName = $("run-schema").value;
        const folder = $("run-folder").value;
        const statusEl = $("run-status");
        const outEl = $("run-output");
        const btnText = $("btn-text");
        const btnIconDefault = $("btn-icon-default");
        const btnIconLoading = $("btn-icon-loading");
        const progressContainer = $("progress-container");
        const progressBar = $("progress-bar");
        const progressLabel = $("progress-label");
        const progressPercent = $("progress-percent");
        const btn = $("btn-run-gemini");

        if (!schemaName || !folder) {
            statusEl.textContent = "‚ö†Ô∏è Select both a schema and a papers folder.";
            return;
        }

        // UI: show loading state
        btn.disabled = true;
        btn.classList.add("opacity-75", "cursor-wait");
        btnText.textContent = "Building...";
        btnIconDefault.classList.add("hidden");
        btnIconLoading.classList.remove("hidden");
        progressContainer.classList.remove("hidden");
        progressBar.style.width = "0%";
        progressLabel.textContent = "Initializing...";
        progressPercent.textContent = "0%";
        statusEl.textContent = "";
        outEl.textContent = "";

        // Progress handler for real-time updates
        function handleProgress(data) {
            const { stage, current, total, message, percent } = data;
            
            // Calculate overall progress based on stage
            let overallPercent = 0;
            switch (stage) {
                case 'init':
                    overallPercent = 5;
                    break;
                case 'loading':
                    overallPercent = 10;
                    break;
                case 'cards':
                    // Cards processing is 10-70% of overall progress
                    overallPercent = 10 + Math.round((current / total) * 60);
                    break;
                case 'saving':
                    // Saving is 70-85%
                    overallPercent = 70 + Math.round((current / total) * 15);
                    break;
                case 'meta':
                    // Meta-card is 85-98%
                    overallPercent = 85 + Math.round((current / total) * 13);
                    break;
                case 'complete':
                    overallPercent = 100;
                    break;
                default:
                    overallPercent = percent || 0;
            }
            
            progressBar.style.width = overallPercent + "%";
            progressLabel.textContent = message;
            progressPercent.textContent = overallPercent + "%";
        }

        try {
            const res = await apiRunGeminiWithProgress(schemaName, folder, handleProgress);
            
            // Complete progress
            progressBar.style.width = "100%";
            progressLabel.textContent = "Complete!";
            progressPercent.textContent = "100%";

            setTimeout(() => {
              progressContainer.classList.add("hidden");
            }, 1500);

            statusEl.innerHTML = '<span class="text-green-400">‚úì Cards built successfully!</span>';

            outEl.innerHTML =
            `<div class="mt-3 p-4 rounded-lg bg-slate-900/50 border border-slate-700 space-y-2">
              <div><span class="text-slate-500">Schema:</span> <span class="text-accentCyan">${res.schema_name}</span></div>
              <div><span class="text-slate-500">Papers:</span> <span class="text-accentCyan">${res.papers_folder}</span></div>
              <div class="pt-2 border-t border-slate-700">
                <div><span class="text-slate-500">üìÑ JSONL:</span> <span class="text-accentPink">/${res.jsonl}</span></div>
                <div><span class="text-slate-500">üìä CSV:</span> <span class="text-accentPink">/${res.csv}</span></div>
                <div><span class="text-slate-500">üìë PDF:</span> <span class="text-accentPink">/${res.pdf}</span></div>
              </div>
            </div>`;
        } catch (err) {
            progressContainer.classList.add("hidden");
            console.error(err);
            statusEl.innerHTML = '<span class="text-red-400">‚úó Error building cards: ' + err.message + '</span>';
            outEl.textContent = "";
        } finally {
            // Reset button state
            btn.disabled = false;
            btn.classList.remove("opacity-75", "cursor-wait");
            btnText.textContent = "Build Cards";
            btnIconDefault.classList.remove("hidden");
            btnIconLoading.classList.add("hidden");
        }
    }


    // ----- Wiring events -----
    window.addEventListener("DOMContentLoaded", async () => {
      await loadTemplatesFromBackend();

      $("nav-welcome").onclick = () => setView("welcome");
      $("nav-question").onclick = () => setView("question");
      $("nav-templates").onclick = () => setView("templates");
      $("nav-runs").onclick = () => {
        setView("runs");
        refreshRunOptions();
      };
      $("nav-editor").onclick = () => setView("editor");

      $("btn-generate").onclick = handleGenerateTemplate;
      $("btn-open-current-from-question").onclick = () => setView("editor");
      $("btn-open-current-from-library").onclick = () => setView("editor");

      $("btn-save-template").onclick = saveCurrentTemplate;
      $("template-name").addEventListener("change", (e) => {
        if (currentTemplate) {
          currentTemplate.name = e.target.value;
        }
      });
      $("toggle-full-json").addEventListener("change", (e) => {
        showFullJSON = e.target.checked;
        renderEditorView();
      });

      $("btn-run-gemini").onclick = handleRunGemini;

      // initial view
      setView("welcome");
    });
  </script>

</body>
</html>
