<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Knowledge Cards Studio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind config (retro-futurist palette) -->
  <script>
    tailwind = {
      theme: {
        extend: {
          fontFamily: {
            mono: ['"IBM Plex Mono"', 'ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', 'monospace'],
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
          colors: {
            bgDeep: '#050814',
            bgPanel: 'rgba(10, 13, 32, 0.95)',
            bgPanelSoft: 'rgba(15, 22, 55, 0.9)',
            accentCyan: '#2dd4ff',
            accentPurple: '#a855ff',
            accentPink: '#f973ff',
            borderSoft: 'rgba(148, 163, 184, 0.35)',
          },
          boxShadow: {
            neon: '0 0 18px rgba(45, 212, 255, 0.25)',
            neonSoft: '0 0 12px rgba(168, 85, 255, 0.25)',
          },
          backgroundImage: {
            grid: "radial-gradient(circle at 1px 1px, rgba(148, 163, 184, 0.15) 1px, transparent 0)",
            voronoi: "url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 200 200'%3E%3Cpath fill='none' stroke='rgba(148,163,184,0.08)' stroke-width='0.5' d='M40 0v200M80 0v200M120 0v200M160 0v200M0 40h200M0 80h200M0 120h200M0 160h200M20 0l40 40M60 0l40 40M100 0l40 40M140 0l40 40M0 20l40 40M0 60l40 40M0 100l40 40M0 140l40 40M160 0l40 40M180 0l20 20M0 160l40 40M0 180l20 20M20 160l40 40M60 160l40 40M100 160l40 40M140 160l60 40M160 20l40 40M160 60l40 40M160 100l40 40M160 140l40 60M180 180l20 20'/%3E%3Ccircle fill='rgba(148,163,184,0.04)' cx='40' cy='40' r='2'/%3E%3Ccircle fill='rgba(148,163,184,0.04)' cx='120' cy='40' r='2'/%3E%3Ccircle fill='rgba(148,163,184,0.04)' cx='80' cy='80' r='2'/%3E%3Ccircle fill='rgba(148,163,184,0.04)' cx='160' cy='80' r='2'/%3E%3Ccircle fill='rgba(148,163,184,0.04)' cx='40' cy='120' r='2'/%3E%3Ccircle fill='rgba(148,163,184,0.04)' cx='120' cy='120' r='2'/%3E%3Ccircle fill='rgba(148,163,184,0.04)' cx='80' cy='160' r='2'/%3E%3Ccircle fill='rgba(148,163,184,0.04)' cx='160' cy='160' r='2'/%3E%3C/svg%3E\")",
          },
        },
      },
    };
  </script>

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: theme('fontFamily.sans');
      background:
        radial-gradient(circle at top left, rgba(45, 212, 255, 0.16), transparent 55%),
        radial-gradient(circle at bottom right, rgba(168, 85, 255, 0.18), transparent 55%),
        #020617;
      color: #e5e7eb;
    }

    .glass {
      background: linear-gradient(
        135deg,
        rgba(15, 23, 42, 0.92),
        rgba(15, 23, 42, 0.85)
      );
      border: 1px solid rgba(148, 163, 184, 0.35);
      backdrop-filter: blur(16px);
    }

    .glass-soft {
      background: linear-gradient(
        135deg,
        rgba(20, 28, 50, 0.95),
        rgba(15, 23, 42, 0.9)
      );
      border: 1px solid rgba(71, 85, 105, 0.6);
      backdrop-filter: blur(12px);
      box-shadow: 
        0 4px 20px rgba(0, 0, 0, 0.4),
        0 0 1px rgba(148, 163, 184, 0.2);
    }

    /* Card variants for different sections */
    .card-cyan {
      background: linear-gradient(
        135deg,
        rgba(20, 35, 55, 0.95),
        rgba(15, 28, 48, 0.9)
      );
      border: 1px solid rgba(45, 212, 255, 0.3);
      box-shadow: 
        0 4px 24px rgba(0, 0, 0, 0.5),
        0 0 20px rgba(45, 212, 255, 0.08),
        inset 0 1px 0 rgba(45, 212, 255, 0.1);
    }

    .card-purple {
      background: linear-gradient(
        135deg,
        rgba(28, 20, 50, 0.95),
        rgba(20, 15, 42, 0.9)
      );
      border: 1px solid rgba(168, 85, 255, 0.3);
      box-shadow: 
        0 4px 24px rgba(0, 0, 0, 0.5),
        0 0 20px rgba(168, 85, 255, 0.08),
        inset 0 1px 0 rgba(168, 85, 255, 0.1);
    }

    .card-pink {
      background: linear-gradient(
        135deg,
        rgba(40, 20, 45, 0.95),
        rgba(30, 15, 35, 0.9)
      );
      border: 1px solid rgba(249, 115, 255, 0.3);
      box-shadow: 
        0 4px 24px rgba(0, 0, 0, 0.5),
        0 0 20px rgba(249, 115, 255, 0.08),
        inset 0 1px 0 rgba(249, 115, 255, 0.1);
    }

    .card-neutral {
      background: linear-gradient(
        135deg,
        rgba(30, 35, 50, 0.95),
        rgba(20, 25, 40, 0.9)
      );
      border: 1px solid rgba(100, 116, 139, 0.4);
      box-shadow: 
        0 4px 20px rgba(0, 0, 0, 0.45),
        inset 0 1px 0 rgba(148, 163, 184, 0.08);
    }

    .card-elevated {
      background: linear-gradient(
        135deg,
        rgba(35, 40, 60, 0.98),
        rgba(25, 30, 50, 0.95)
      );
      border: 1px solid rgba(100, 116, 139, 0.5);
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.6),
        0 2px 8px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }

    .cyber-border {
      border-image: linear-gradient(
        to bottom,
        rgba(45, 212, 255, 0.9),
        rgba(168, 85, 255, 0.7)
      ) 1;
    }

    .glow-ring {
      box-shadow:
        0 0 0 1px rgba(148, 163, 184, 0.2),
        0 0 20px rgba(45, 212, 255, 0.24);
    }

    .neon-pill {
      background: radial-gradient(circle at 0% 0%, rgba(45, 212, 255, 0.35), transparent 60%),
                  linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.85));
      border: 1px solid rgba(56, 189, 248, 0.6);
    }

    .nav-active {
      background: linear-gradient(90deg, rgba(45, 212, 255, 0.24), transparent);
      border-left: 2px solid rgba(45, 212, 255, 0.95);
      color: #e5e7eb;
      box-shadow: 0 0 18px rgba(45, 212, 255, 0.2);
    }

    .nav-idle {
      color: #9ca3af;
    }

    .nav-idle:hover {
      background: linear-gradient(90deg, rgba(15, 23, 42, 0.9), transparent);
      color: #e5e7eb;
    }

    .code-chip {
      border-radius: 9999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: radial-gradient(circle at 0 0, rgba(45, 212, 255, 0.4), transparent 60%);
    }

    /* Selection states for viz options */
    .viz-selected-cyan {
      border: 2px solid #2dd4ff !important;
      background: rgba(45, 212, 255, 0.15) !important;
      box-shadow: 0 0 20px rgba(45, 212, 255, 0.2);
    }
    .viz-selected-purple {
      border: 2px solid #a855ff !important;
      background: rgba(168, 85, 255, 0.15) !important;
      box-shadow: 0 0 20px rgba(168, 85, 255, 0.2);
    }
    .viz-selected-pink {
      border: 2px solid #f973ff !important;
      background: rgba(249, 115, 255, 0.15) !important;
      box-shadow: 0 0 20px rgba(249, 115, 255, 0.2);
    }
    .viz-selected-green {
      border: 2px solid #4ade80 !important;
      background: rgba(74, 222, 128, 0.15) !important;
      box-shadow: 0 0 20px rgba(74, 222, 128, 0.2);
    }
    .viz-unselected {
      border: 1px solid rgb(71, 85, 105) !important;
      background: rgba(30, 41, 59, 0.4) !important;
    }

    /* Section headers with colored accents */
    .section-header-cyan {
      border-left: 3px solid rgba(45, 212, 255, 0.8);
      padding-left: 12px;
    }

    .section-header-purple {
      border-left: 3px solid rgba(168, 85, 255, 0.8);
      padding-left: 12px;
    }

    .section-header-pink {
      border-left: 3px solid rgba(249, 115, 255, 0.8);
      padding-left: 12px;
    }

    /* Subtle hover effects */
    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.5),
        0 0 30px rgba(45, 212, 255, 0.1);
    }

    .card-hover {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
  </style>
</head>
<body class="h-screen w-screen flex">

  <!-- Sidebar -->
  <aside class="w-72 glass flex flex-col shadow-neon">
    <div class="px-5 py-4 border-b borderSoft flex items-center justify-between">
      <div>
        <div class="font-mono text-sm tracking-[0.18em] uppercase text-slate-300">
          // Studio
        </div>
        <div class="mt-1 text-lg font-mono tracking-tight">
          <span class="text-accentCyan">Knowledge</span>
          <span class="text-slate-100">Cards</span>
        </div>
      </div>
      <div class="code-chip px-2.5 py-1 text-[0.65rem] font-mono text-slate-50 shadow-neonSoft">
        TS ‚Ä¢ R∆í
      </div>
    </div>

    <nav class="flex-1 px-3 py-4 text-[0.8rem] space-y-1">
      <button id="nav-welcome"
        class="w-full text-left px-3 py-2.5 rounded-md nav-active flex items-center gap-2 font-mono text-xs transition-all">
        <span class="text-accentCyan">‚ú¶</span>
        <span>Welcome</span>
      </button>
      <button id="nav-question"
        class="w-full text-left px-3 py-2.5 rounded-md nav-idle flex items-center gap-2 font-mono text-xs transition-all">
        <span class="text-slate-500">‚ñÆ</span>
        <span>New template from question</span>
      </button>
      <button id="nav-templates"
        class="w-full text-left px-3 py-2.5 rounded-md nav-idle flex items-center gap-2 font-mono text-xs transition-all">
        <span class="text-slate-500">‚ñØ</span>
        <span>Template library</span>
      </button>
      <button id="nav-runs"
        class="w-full text-left px-3 py-2.5 rounded-md nav-idle flex items-center gap-2 font-mono text-xs transition-all">
        <span class="text-slate-500">‚óé</span>
        <span>Runs / reports</span>
      </button>
      <button id="nav-visualize"
        class="w-full text-left px-3 py-2.5 rounded-md nav-idle flex items-center gap-2 font-mono text-xs transition-all">
        <span class="text-slate-500">‚óà</span>
        <span>Visualize cards</span>
      </button>
      <button id="nav-editor"
        class="w-full text-left px-3 py-2.5 rounded-md nav-idle flex items-center gap-2 font-mono text-xs transition-all hidden">
        <span class="text-slate-500">‚úé</span>
        <span>Edit current template</span>
      </button>
    </nav>

    <div class="px-5 py-3 border-t borderSoft text-[0.65rem] text-slate-500 font-mono">
      <div class="flex items-center justify-between">
        <span id="session-indicator" class="text-slate-600">session: ---</span>
        <span class="text-accentPurple">v0.1</span>
      </div>
    </div>
  </aside>

  <!-- Main content -->
  <main class="flex-1 overflow-hidden px-4 py-4">
    <div class="h-full w-full glass-soft rounded-xl shadow-neonSoft border cyber-border bg-voronoi overflow-auto flex flex-col">

      <!-- Top bar -->
      <header class="px-6 py-3 border-b borderSoft flex items-center justify-between">
        <div>
          <div class="font-mono text-[0.7rem] tracking-[0.2em] uppercase text-slate-400">
            Gemini ‚Ä¢ schema ‚Ä¢ cards
          </div>
          <div class="mt-0.5 text-sm text-slate-300">
            Design templates, then run synthesis pipelines over your PDFs.
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button
            class="neon-pill px-3 py-1.5 text-[0.7rem] font-mono text-slate-50 flex items-center gap-1 shadow-neon">
            <span class="text-accentCyan">‚óè</span>
            <span>connected</span>
          </button>
        </div>
      </header>

      <!-- View: Welcome -->
      <section id="view-welcome" class="flex-1 overflow-auto">
        <div class="max-w-5xl mx-auto py-8 px-6">
          
          <!-- Hero Section -->
          <div class="grid lg:grid-cols-2 gap-10 items-center mb-16">
            <div class="space-y-6">
              <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-mono bg-slate-800/50 border border-slate-700 text-slate-400">
                <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
                Powered by Gemini AI
              </div>
              
              <h1 class="text-4xl lg:text-5xl font-bold leading-tight">
                Transform Scientific Writing into
                <span style="background: linear-gradient(135deg, #2dd4ff, #a855ff, #f973ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"> Structured Insights</span>
              </h1>
              
              <p class="text-lg text-slate-400 leading-relaxed">
                A schema-agnostic LLM pipeline that transforms scientific litterature into structured JSON knowledge cards. Design your own knowledge templates, process PDFs, and generate beautiful reports.
              </p>
              
              <div class="flex items-center gap-4">
                <button onclick="setView('question')" class="group px-5 py-2.5 rounded-lg font-medium text-sm text-white shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-200" style="background: linear-gradient(90deg, #2dd4ff, #a855ff, #f973ff);">
                  <span class="flex items-center gap-2">
                    Get Started
                    <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                    </svg>
                  </span>
                </button>
                <a href="https://github.com/AntoineBellemare/knowledge-cards" target="_blank" class="px-5 py-2.5 rounded-lg font-medium text-sm border border-slate-600 text-slate-300 hover:bg-slate-800 hover:border-slate-500 transition-all flex items-center gap-2">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                  </svg>
                  GitHub
                </a>
              </div>
            </div>
            
            <div class="relative">
              <div class="absolute inset-0 rounded-2xl blur-3xl" style="background: linear-gradient(135deg, rgba(45, 212, 255, 0.2), rgba(168, 85, 255, 0.2));"></div>
              <img 
                src="assets/cover.png" 
                alt="Knowledge Cards Preview" 
                class="relative rounded-2xl shadow-2xl border border-slate-700/50"
                style="mask-image: linear-gradient(to bottom, black 70%, transparent 100%); -webkit-mask-image: linear-gradient(to bottom, black 70%, transparent 100%);"
              />
            </div>
          </div>

          <!-- Features Section -->
          <div class="mb-16">
            <div class="text-center mb-10">
              <h2 class="text-2xl font-bold mb-3">Powerful Features</h2>
              <p class="text-slate-400">Everything you need to distill structured knowledge from your research papers.</p>
            </div>
            
            <div class="grid md:grid-cols-3 gap-4">
              <div class="card-cyan rounded-xl p-5 hover:scale-[1.02] transition-transform card-hover">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center mb-3" style="background: linear-gradient(135deg, rgba(45, 212, 255, 0.2), rgba(168, 85, 255, 0.2)); border: 1px solid rgba(45, 212, 255, 0.3);">
                  <svg class="w-5 h-5" style="color: #2dd4ff;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                </div>
                <h3 class="font-semibold mb-1">Schema-Agnostic</h3>
                <p class="text-slate-400 text-sm">Design your own knowledge templates. Define exactly what information you want to pull.</p>
              </div>

              <div class="card-purple rounded-xl p-5 hover:scale-[1.02] transition-transform card-hover">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center mb-3" style="background: linear-gradient(135deg, rgba(168, 85, 255, 0.2), rgba(249, 115, 255, 0.2)); border: 1px solid rgba(168, 85, 255, 0.3);">
                  <svg class="w-5 h-5" style="color: #a855ff;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                  </svg>
                </div>
                <h3 class="font-semibold mb-1">AI-Powered Synthesis</h3>
                <p class="text-slate-400 text-sm">Leverage Google Gemini to intelligently reveal and structure information.</p>
              </div>

              <div class="card-pink rounded-xl p-5 hover:scale-[1.02] transition-transform card-hover">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center mb-3" style="background: linear-gradient(135deg, rgba(249, 115, 255, 0.2), rgba(45, 212, 255, 0.2)); border: 1px solid rgba(249, 115, 255, 0.3);">
                  <svg class="w-5 h-5" style="color: #f973ff;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                </div>
                <h3 class="font-semibold mb-1">Beautiful Reports</h3>
                <p class="text-slate-400 text-sm">Generate professional PDF reports with structured cards for each paper.</p>
              </div>

              <div class="card-cyan rounded-xl p-5 hover:scale-[1.02] transition-transform card-hover">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center mb-3" style="background: linear-gradient(135deg, rgba(45, 212, 255, 0.2), rgba(168, 85, 255, 0.2)); border: 1px solid rgba(45, 212, 255, 0.3);">
                  <svg class="w-5 h-5" style="color: #2dd4ff;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
                  </svg>
                </div>
                <h3 class="font-semibold mb-1">Multiple Outputs</h3>
                <p class="text-slate-400 text-sm">Export to JSONL, CSV, and PDF formats for analysis or sharing.</p>
              </div>

              <div class="card-purple rounded-xl p-5 hover:scale-[1.02] transition-transform card-hover">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center mb-3" style="background: linear-gradient(135deg, rgba(168, 85, 255, 0.2), rgba(249, 115, 255, 0.2)); border: 1px solid rgba(168, 85, 255, 0.3);">
                  <svg class="w-5 h-5" style="color: #a855ff;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z"/>
                  </svg>
                </div>
                <h3 class="font-semibold mb-1">Meta-Card Synthesis</h3>
                <p class="text-slate-400 text-sm">Automatically generate a synthesized overview combining all papers.</p>
              </div>

              <div class="card-pink rounded-xl p-5 hover:scale-[1.02] transition-transform card-hover">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center mb-3" style="background: linear-gradient(135deg, rgba(249, 115, 255, 0.2), rgba(45, 212, 255, 0.2)); border: 1px solid rgba(249, 115, 255, 0.3);">
                  <svg class="w-5 h-5" style="color: #f973ff;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
                  </svg>
                </div>
                <h3 class="font-semibold mb-1">Real-time Progress</h3>
                <p class="text-slate-400 text-sm">Watch your cards being built with live progress updates.</p>
              </div>
            </div>
          </div>

          <!-- How it Works Section -->
          <div class="mb-10">
            <div class="text-center mb-10">
              <h2 class="text-2xl font-bold mb-3">How It Works</h2>
              <p class="text-slate-400">Three simple steps to structured knowledge</p>
            </div>
            
            <div class="space-y-6">
              <div class="flex gap-5 items-start">
                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-accentCyan/20 border border-accentCyan/50 flex items-center justify-center shadow-lg">
                  <span class="text-xl font-bold text-accentCyan">1</span>
                </div>
                <div class="flex-1 card-cyan rounded-xl p-5">
                  <h3 class="font-semibold mb-2">Design Your Template</h3>
                  <p class="text-slate-400 text-sm mb-3">Ask a research question, and let AI generate a structured schema ‚Äî or create your own custom template with exactly the fields you need.</p>
                  <div class="rounded-lg p-3 font-mono text-xs bg-black/40 border border-slate-700">
                    <span class="text-slate-500">// Example question:</span><br>
                    <span style="color: #2dd4ff;">"How does network dynamics change across biological lifeforms?"</span>
                  </div>
                </div>
              </div>

              <div class="flex gap-5 items-start">
                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-accentPurple/20 border border-accentPurple/50 flex items-center justify-center shadow-lg">
                  <span class="text-xl font-bold text-accentPurple">2</span>
                </div>
                <div class="flex-1 card-purple rounded-xl p-5">
                  <h3 class="font-semibold mb-2">Add Your Papers</h3>
                  <p class="text-slate-400 text-sm mb-3">
                    <span class="text-slate-300 font-medium">Local:</span> Place PDFs in a subfolder under <code class="px-1.5 py-0.5 rounded bg-slate-800 text-accentCyan text-xs">papers/</code><br>
                    <span class="text-slate-300 font-medium">Online:</span> Upload PDFs directly via the "Upload Papers" section in the Runs tab.
                  </p>
                  <div class="rounded-lg p-3 font-mono text-xs bg-black/40 border border-slate-700 text-slate-400">
                    <div class="flex items-center gap-2 mb-1">
                      <span class="text-accentCyan">üíª Local:</span> papers/my_topic/*.pdf
                    </div>
                    <div class="flex items-center gap-2">
                      <span class="text-accentPink">‚òÅÔ∏è Online:</span> Upload via UI ‚Üí select folder name ‚Üí add PDFs
                    </div>
                  </div>
                </div>
              </div>

              <div class="flex gap-5 items-start">
                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-accentPink/20 border border-accentPink/50 flex items-center justify-center shadow-lg">
                  <span class="text-xl font-bold text-accentPink">3</span>
                </div>
                <div class="flex-1 card-pink rounded-xl p-5">
                  <h3 class="font-semibold mb-2">Build Your Cards</h3>
                  <p class="text-slate-400 text-sm mb-3">Click "Build Cards" and watch the magic happen. Get individual cards for each paper, plus a synthesized meta-card combining all insights.</p>
                  <div class="flex flex-wrap gap-2 mt-3">
                    <span class="px-2.5 py-1 rounded-full text-xs font-mono bg-slate-800/80 border border-slate-600 shadow-sm">üìÑ cards.jsonl</span>
                    <span class="px-2.5 py-1 rounded-full text-xs font-mono bg-slate-800/80 border border-slate-600 shadow-sm">üìä summary.csv</span>
                    <span class="px-2.5 py-1 rounded-full text-xs font-mono bg-slate-800/80 border border-slate-600 shadow-sm">üìë report.pdf</span>
                    <span class="px-2.5 py-1 rounded-full text-xs font-mono bg-slate-800/80 border border-slate-600 shadow-sm">üß† meta-card.pdf</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- CTA -->
          <div class="text-center card-elevated rounded-2xl p-8 relative overflow-hidden">
            <div class="absolute inset-0" style="background: linear-gradient(135deg, rgba(45, 212, 255, 0.08), rgba(168, 85, 255, 0.08), rgba(249, 115, 255, 0.08));"></div>
            <div class="relative">
              <h2 class="text-2xl font-bold mb-3">Ready to Transform Your Research?</h2>
              <p class="text-slate-400 mb-6">Start uncovering structured insights from your papers today.</p>
              <button onclick="setView('question')" class="inline-flex items-center gap-2 px-6 py-3 rounded-xl font-semibold text-white shadow-xl hover:shadow-2xl hover:scale-105 transition-all duration-200" style="background: linear-gradient(90deg, #2dd4ff, #a855ff, #f973ff);">
                Start Building Cards
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                </svg>
              </button>
            </div>
          </div>

          <!-- Footer -->
          <div class="mt-10 pt-6 border-t border-slate-700 flex items-center justify-between text-sm text-slate-500">
            <span>Built with üíú by Antoine Bellemare</span>
            <a href="https://github.com/AntoineBellemare/knowledge-cards" target="_blank" class="hover:text-white transition-colors flex items-center gap-1">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
              </svg>
              GitHub
            </a>
          </div>
        </div>
      </section>

      <!-- View: Question -->
      <section id="view-question" class="flex-1 overflow-auto hidden">
        <div class="max-w-4xl mx-auto py-7 px-6">
          <h1 class="text-2xl font-semibold text-slate-100 tracking-tight mb-1">
            New template from question
          </h1>
          <p class="text-sm text-slate-400 mb-5 max-w-2xl">
            Ask a high-level question. The system will synthesize a structured card template
            to annotate and compare papers that speak to that question.
          </p>

          <label class="block text-xs font-mono tracking-wide text-slate-400 mb-1">
            QUESTION
          </label>
          <div class="rounded-lg glow-ring bg-slate-950/60">
            <textarea id="question-input"
              class="w-full bg-transparent rounded-lg px-3 py-3 text-sm text-slate-100 focus:outline-none font-mono"
              rows="4">how does network dynamics change across biological lifeforms</textarea>
          </div>

          <div class="mt-5 grid grid-cols-2 gap-3 text-[0.75rem]">
            <label class="flex items-center gap-2 text-slate-300">
              <input type="checkbox" id="opt-conceptual" checked
                class="rounded border-slate-500 bg-slate-900/60" />
              <span>Emphasize conceptual / philosophical aspects</span>
            </label>
            <label class="flex items-center gap-2 text-slate-300">
              <input type="checkbox" id="opt-empirical" checked
                class="rounded border-slate-500 bg-slate-900/60" />
              <span>Include empirical / methods structure</span>
            </label>
            <label class="flex items-center gap-2 text-slate-300">
              <input type="checkbox" id="opt-metapoetic"
                class="rounded border-slate-500 bg-slate-900/60" />
              <span>Include metaphysical / poetic dimensions</span>
            </label>
            <label class="flex items-center gap-2 text-slate-300">
              <input type="checkbox" id="opt-ethics"
                class="rounded border-slate-500 bg-slate-900/60" />
              <span>Include ethics / community / context</span>
            </label>
          </div>

          <div class="mt-7 flex items-center gap-4 flex-wrap">
            <div class="flex items-center gap-2">
              <label class="text-xs text-slate-400">Model:</label>
              <select id="template-model"
                class="bg-slate-900/80 border border-slate-600 rounded-lg px-2 py-1.5 text-xs font-mono text-slate-100 focus:outline-none focus:border-accentCyan">
                <option value="gemini-2.5-flash-lite">gemini-2.5-flash-lite (fast)</option>
                <option value="gemini-2.5-flash">gemini-2.5-flash (balanced)</option>
                <option value="gemini-2.5-pro">gemini-2.5-pro (best)</option>
              </select>
            </div>
            <button id="btn-generate"
                class="inline-flex items-center px-4 py-2.5 rounded-md bg-[#f8f8f4] text-slate-900 text-xs font-mono tracking-wide shadow-neon hover:brightness-95 transition-all">
                <span class="mr-1">‚ö°</span>
                <span>Generate template</span>
            </button>
            <button id="btn-open-current-from-question"
              class="text-xs font-mono text-accentCyan hover:underline hidden">
              ‚á¢ Open current template
            </button>
          </div>

          <div id="question-status" class="mt-3 text-[0.7rem] font-mono text-slate-400"></div>
        </div>
      </section>

      <!-- View: Templates -->
      <section id="view-templates" class="flex-1 overflow-auto hidden">
        <div class="max-w-5xl mx-auto py-7 px-6">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h1 class="text-2xl font-semibold text-slate-100 tracking-tight">
                Template library
              </h1>
              <p class="text-xs text-slate-400 mt-1">
                Saved schemas for different questions and projects.
              </p>
            </div>
            <button id="btn-open-current-from-library"
              class="text-xs font-mono text-accentCyan hover:underline hidden">
              ‚á¢ Edit current template
            </button>
          </div>

          <div id="templates-empty" class="card-neutral rounded-xl p-8 text-center text-sm text-slate-400">
            <div class="text-4xl mb-3 opacity-50">üìÅ</div>
            No templates saved yet. Generate a template from a question, then click
            <span class="font-mono text-accentCyan">Save to library</span> in the editor.
          </div>

          <div id="templates-list" class="space-y-3 hidden"></div>
        </div>
      </section>

      <!-- View: Runs -->
    <section id="view-runs" class="flex-1 overflow-auto hidden">
    <div class="max-w-3xl mx-auto py-7 px-6 space-y-5">
        <div class="card-cyan rounded-xl p-5">
        <h1 class="text-2xl font-semibold text-slate-100 mb-1">
            Runs &amp; reports
        </h1>
        <p class="text-sm text-slate-400">
            Pick a card template (schema) and a folder of PDFs, then run the
            Gemini pipeline.
        </p>
        </div>

        <!-- Upload Papers Section -->
        <div class="card-neutral rounded-xl p-5 space-y-4">
          <div class="flex items-center justify-between">
            <h2 class="text-sm font-semibold text-slate-200 section-header-cyan flex items-center gap-2">
              <svg class="w-4 h-4 text-accentCyan" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
              </svg>
              Upload Papers
            </h2>
            <span class="text-xs text-slate-500 font-mono">PDF files only</span>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="block text-xs font-mono text-slate-400 mb-1">
                FOLDER NAME
              </label>
              <input id="upload-folder-name" type="text" placeholder="e.g., my_research_papers"
                class="w-full bg-slate-900/80 border border-slate-600 rounded-lg px-3 py-2 text-xs font-mono text-slate-100 placeholder-slate-600 focus:outline-none focus:border-accentCyan focus:ring-1 focus:ring-accentCyan/30" />
            </div>
            <div>
              <label class="block text-xs font-mono text-slate-400 mb-1">
                SELECT PDFs
              </label>
              <input id="upload-files" type="file" multiple accept=".pdf"
                class="w-full bg-slate-900/80 border border-slate-600 rounded-lg px-2 py-1.5 text-xs font-mono text-slate-100 file:mr-3 file:py-1 file:px-3 file:rounded-md file:border-0 file:text-xs file:font-mono file:bg-accentPurple/20 file:text-accentPurple hover:file:bg-accentPurple/30 cursor-pointer" />
            </div>
          </div>
          
          <div class="flex items-center gap-3">
            <button id="btn-upload-papers"
              class="px-4 py-2 rounded-lg bg-accentCyan/20 hover:bg-accentCyan/30 border border-accentCyan/50 text-white text-xs font-mono transition-all flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
              </svg>
              Upload to Server
            </button>
            <span id="upload-status" class="text-xs font-mono text-slate-400"></span>
          </div>
        </div>

        <!-- Run Pipeline Section -->
        <div class="card-purple rounded-xl p-5 space-y-4">
        <div class="flex items-center justify-between">
          <h2 class="text-sm font-semibold text-slate-200 section-header-purple flex items-center gap-2">
            <svg class="w-4 h-4 text-accentPurple" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
            </svg>
            Run Pipeline
          </h2>
          <button id="btn-refresh-folders" class="text-xs text-accentPurple hover:text-white font-mono flex items-center gap-1 transition-colors">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            Refresh
          </button>
        </div>
        
        <div class="grid grid-cols-1 gap-4">
            <div>
            <label class="block text-xs font-mono text-slate-400 mb-1">
                CARD TEMPLATE (schema)
            </label>
            <select id="run-schema"
                class="w-full bg-slate-900/80 border border-slate-600 rounded-lg px-2 py-2 text-xs font-mono text-slate-100 focus:outline-none focus:border-accentPurple focus:ring-1 focus:ring-accentPurple/30">
                <option value="">‚Äî select schema ‚Äî</option>
            </select>
            </div>

            <div>
            <label class="block text-xs font-mono text-slate-400 mb-1">
                PAPERS FOLDER
            </label>
            <select id="run-folder"
                class="w-full bg-slate-900/80 border border-slate-600 rounded-lg px-2 py-2 text-xs font-mono text-slate-100 focus:outline-none focus:border-accentPurple focus:ring-1 focus:ring-accentPurple/30">
                <option value="">‚Äî select folder ‚Äî</option>
            </select>
            </div>

            <div>
            <label class="block text-xs font-mono text-slate-400 mb-1">
                AI MODEL
            </label>
            <select id="run-model"
                class="w-full bg-slate-900/80 border border-slate-600 rounded-lg px-2 py-2 text-xs font-mono text-slate-100 focus:outline-none focus:border-accentPurple focus:ring-1 focus:ring-accentPurple/30">
                <option value="gemini-2.5-flash-lite">gemini-2.5-flash-lite (fastest, cheapest)</option>
                <option value="gemini-2.5-flash">gemini-2.5-flash (balanced)</option>
                <option value="gemini-2.5-pro">gemini-2.5-pro (best quality)</option>
            </select>
            </div>
        </div>

        <div class="flex flex-col gap-4">
            <button id="btn-run-gemini"
              class="group relative px-6 py-3 rounded-lg bg-gradient-to-r from-accentCyan via-accentPurple to-accentPink text-white text-sm font-semibold shadow-neon hover:shadow-lg hover:scale-[1.02] transition-all duration-200 overflow-hidden">
              <span class="relative z-10 flex items-center justify-center gap-2">
                <svg id="btn-icon-default" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                </svg>
                <svg id="btn-icon-loading" class="w-5 h-5 animate-spin hidden" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="btn-text">Build Cards</span>
              </span>
              <div class="absolute inset-0 bg-gradient-to-r from-white/0 via-white/20 to-white/0 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"></div>
            </button>
            
            <!-- Progress bar -->
            <div id="progress-container" class="hidden">
              <div class="flex justify-between text-xs text-slate-400 mb-1">
                <span id="progress-label">Initializing...</span>
                <span id="progress-percent">0%</span>
              </div>
              <div class="h-3 bg-slate-800 rounded-full overflow-hidden shadow-inner">
                <div id="progress-bar" class="h-full rounded-full transition-all duration-300 ease-out" style="width: 0%; background: linear-gradient(90deg, #2dd4ff, #a855ff, #f973ff);"></div>
              </div>
            </div>
            
            <span id="run-status" class="text-xs font-mono text-slate-400"></span>
        </div>

        <div id="run-output" class="text-[0.75rem] font-mono text-slate-300"></div>
        </div>

        <!-- Download Results Section -->
        <div class="card-pink rounded-xl p-5 space-y-4">
          <div class="flex items-center justify-between">
            <h2 class="text-sm font-semibold text-slate-200 section-header-pink flex items-center gap-2">
              <svg class="w-4 h-4 text-accentPink" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              Download Results
            </h2>
            <button id="btn-refresh-results" class="text-xs text-accentPink hover:text-white font-mono flex items-center gap-1 transition-colors">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
              </svg>
              Refresh
            </button>
          </div>
          
          <div id="results-list" class="text-xs font-mono text-slate-400">
            <p>Click "Refresh" to load available result files.</p>
          </div>
        </div>
    </div>
    </section>

      <!-- View: Visualize -->
      <section id="view-visualize" class="flex-1 overflow-auto hidden">
        <div class="max-w-5xl mx-auto p-6 space-y-6">
          
          <!-- Header -->
          <div class="card-pink rounded-xl p-5">
            <div class="flex items-center gap-3 mb-3">
              <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: linear-gradient(135deg, rgba(249, 115, 255, 0.3), rgba(45, 212, 255, 0.2)); border: 1px solid rgba(249, 115, 255, 0.4);">
                <svg class="w-5 h-5 text-accentPink" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
              </div>
              <div>
                <h1 class="text-lg font-semibold text-slate-100">Visualize Knowledge Cards</h1>
                <p class="text-xs text-slate-400">Generate AI-powered visual representations of your knowledge cards</p>
              </div>
            </div>
          </div>

          <!-- API Key Input -->
          <div class="card-neutral rounded-xl p-5">
            <label class="block text-xs font-mono text-slate-400 mb-2">Google AI API Key (for image generation)</label>
            <input id="viz-api-key" type="password" 
              class="w-full bg-slate-900/80 border border-slate-600 rounded-lg px-3 py-2 text-sm text-slate-200 focus:outline-none focus:border-accentCyan focus:ring-1 focus:ring-accentCyan/30"
              placeholder="Enter your Gemini API key..." />
            <p class="text-xs text-slate-500 mt-2">Get a key at <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-accentCyan hover:underline">aistudio.google.com</a></p>
          </div>

          <!-- Card Selection -->
          <div class="card-cyan rounded-xl p-5 space-y-4">
            <h2 class="text-sm font-semibold text-slate-200 section-header-cyan">
              <span class="text-accentCyan mr-2">1.</span> Select Card Data
            </h2>
            
            <!-- Meta-Cards Section -->
            <div class="space-y-2 p-3 rounded-lg bg-slate-900/40 border border-slate-700/50">
              <label class="block text-xs font-mono text-slate-400 flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-accentPink animate-pulse"></span>
                Meta-Cards (Synthesis)
              </label>
              <select id="viz-meta-cards" class="w-full bg-slate-900/80 border border-slate-600 rounded-lg px-3 py-2 text-sm text-slate-200 focus:outline-none focus:border-accentPink focus:ring-1 focus:ring-accentPink/30">
                <option value="">-- Select a meta-card --</option>
              </select>
            </div>
            
            <!-- Individual Cards Section -->
            <div class="space-y-2 p-3 rounded-lg bg-slate-900/40 border border-slate-700/50">
              <label class="block text-xs font-mono text-slate-400 flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-accentCyan"></span>
                Individual Paper Cards
              </label>
              <div class="grid md:grid-cols-2 gap-3">
                <select id="viz-individual-files" class="w-full bg-slate-900/80 border border-slate-600 rounded-lg px-3 py-2 text-sm text-slate-200 focus:outline-none focus:border-accentCyan focus:ring-1 focus:ring-accentCyan/30">
                  <option value="">-- Select result file --</option>
                </select>
                <select id="viz-individual-cards" class="w-full bg-slate-900/80 border border-slate-600 rounded-lg px-3 py-2 text-sm text-slate-200 focus:outline-none focus:border-accentCyan focus:ring-1 focus:ring-accentCyan/30" disabled>
                  <option value="">-- Select file first --</option>
                </select>
              </div>
            </div>

            <button id="btn-load-card" class="px-4 py-2 rounded-lg text-sm font-medium bg-accentCyan/20 hover:bg-accentCyan/30 border border-accentCyan/50 text-slate-200 transition-all flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
              </svg>
              Load Card Data
            </button>
            
            <div id="viz-card-preview" class="hidden">
              <div class="p-3 rounded-lg bg-slate-800/60 border border-accentCyan/30 shadow-lg">
                <div class="flex justify-between items-start mb-2">
                  <span id="viz-card-title" class="text-accentCyan font-medium text-sm"></span>
                  <span id="viz-card-type-badge" class="text-xs px-2 py-0.5 rounded bg-slate-700 text-slate-300"></span>
                </div>
                <p id="viz-card-summary" class="text-xs text-slate-400 line-clamp-3"></p>
              </div>
            </div>
            
            <!-- Category Selection Submenu -->
            <div id="viz-categories-panel" class="hidden mt-4 p-4 rounded-lg bg-slate-900/60 border border-accentPurple/30">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-xs font-semibold text-slate-300 flex items-center gap-2">
                  <svg class="w-4 h-4 text-accentPurple" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
                  </svg>
                  Select Categories to Include
                </h3>
                <label class="flex items-center gap-2 text-xs text-slate-400 cursor-pointer hover:text-slate-200">
                  <input type="checkbox" id="viz-select-all-categories" checked class="w-3.5 h-3.5 rounded border-slate-500 bg-slate-800 text-accentPurple focus:ring-accentPurple/50" />
                  Select All
                </label>
              </div>
              <div id="viz-categories-list" class="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-48 overflow-y-auto">
                <!-- Categories will be populated dynamically -->
              </div>
              <p class="text-xs text-slate-500 mt-3 italic">Uncheck categories to focus the visualization on specific aspects</p>
            </div>
          </div>

          <!-- Visualization Mode -->
          <div class="card-purple rounded-xl p-5 space-y-4">
            <h2 class="text-sm font-semibold text-slate-200 section-header-purple">
              <span class="text-accentPurple mr-2">2.</span> Choose Visualization Style
            </h2>
            
            <div class="grid md:grid-cols-2 gap-3" id="viz-mode-grid">
              <div class="viz-mode-option cursor-pointer p-4 rounded-lg viz-selected-cyan transition-all hover:scale-[1.02] shadow-lg card-hover" data-value="schematic">
                <div class="flex items-center gap-3 mb-2">
                  <span class="text-xl">üìê</span>
                  <span class="font-medium text-sm text-slate-200">Precise Schematic</span>
                </div>
                <p class="text-xs text-slate-400">Technical diagram showing key concepts, relationships, and hierarchies with clean geometric forms.</p>
              </div>
              
              <div class="viz-mode-option cursor-pointer p-4 rounded-lg viz-unselected transition-all hover:scale-[1.02] hover:bg-slate-700/50 shadow-md card-hover" data-value="intuitive">
                <div class="flex items-center gap-3 mb-2">
                  <span class="text-xl">üé®</span>
                  <span class="font-medium text-sm text-slate-200">Intuitive Display</span>
                </div>
                <p class="text-xs text-slate-400">Artistic, metaphorical visualization that captures the essence and feeling of the research themes.</p>
              </div>
              
              <div class="viz-mode-option cursor-pointer p-4 rounded-lg viz-unselected transition-all hover:scale-[1.02] hover:bg-slate-700/50 shadow-md card-hover" data-value="network">
                <div class="flex items-center gap-3 mb-2">
                  <span class="text-xl">üï∏Ô∏è</span>
                  <span class="font-medium text-sm text-slate-200">Network Graph</span>
                </div>
                <p class="text-xs text-slate-400">Node-link diagram emphasizing connections between concepts, systems, and findings.</p>
              </div>
              
              <div class="viz-mode-option cursor-pointer p-4 rounded-lg viz-unselected transition-all hover:scale-[1.02] hover:bg-slate-700/50 shadow-md card-hover" data-value="infographic">
                <div class="flex items-center gap-3 mb-2">
                  <span class="text-xl">üìä</span>
                  <span class="font-medium text-sm text-slate-200">Data Infographic</span>
                </div>
                <p class="text-xs text-slate-400">Information-rich poster with stats, key findings, and organized data blocks.</p>
              </div>
            </div>
            <input type="hidden" id="viz-mode-value" value="schematic" />
          </div>

          <!-- Model Selection -->
          <div class="card-neutral rounded-xl p-5 space-y-4">
            <h2 class="text-sm font-semibold text-slate-200 section-header-cyan">
              <span class="text-accentCyan mr-2">3.</span> Select Image Model
            </h2>
            
            <div class="grid md:grid-cols-2 gap-3" id="viz-model-grid">
              <div class="viz-model-option cursor-pointer p-3 rounded-lg viz-selected-cyan transition-all hover:scale-[1.02] shadow-md card-hover" data-value="gemini-2.5-flash-image">
                <div class="font-medium text-sm text-slate-200">Gemini 2.5 Flash</div>
                <p class="text-xs text-slate-500">Fast image generation</p>
              </div>
              
              <div class="viz-model-option cursor-pointer p-3 rounded-lg viz-unselected transition-all hover:scale-[1.02] hover:bg-slate-700/50 shadow-md card-hover" data-value="imagen-4.0-generate-001">
                <div class="font-medium text-sm text-slate-200">Imagen 4</div>
                <p class="text-xs text-slate-500">High-quality image generation</p>
              </div>
              
              <div class="viz-model-option cursor-pointer p-3 rounded-lg viz-unselected transition-all hover:scale-[1.02] hover:bg-slate-700/50 shadow-md card-hover" data-value="gemini-3-pro-image-preview">
                <div class="font-medium text-sm text-slate-200">Gemini 3 Pro</div>
                <p class="text-xs text-slate-500">Higher quality, slower</p>
              </div>
              
              <div class="viz-model-option cursor-pointer p-3 rounded-lg viz-unselected transition-all hover:scale-[1.02] hover:bg-slate-700/50 shadow-md card-hover" data-value="nano-banana-pro-preview">
                <div class="font-medium text-sm text-slate-200">üçå Nano Banana</div>
                <p class="text-xs text-slate-500">Experimental model</p>
              </div>
            </div>
            <input type="hidden" id="viz-model-value" value="gemini-2.5-flash-image" />
          </div>

          <!-- Generate Button -->
          <div class="card-elevated rounded-xl p-5 space-y-4">
            <button id="btn-generate-viz" class="w-full px-6 py-3 rounded-xl font-semibold text-white shadow-xl hover:shadow-2xl hover:scale-[1.02] transition-all duration-200 flex items-center justify-center gap-2" style="background: linear-gradient(90deg, #2dd4ff, #a855ff, #f973ff);">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
              Generate Visualization
            </button>
            
            <div id="viz-status" class="text-center text-xs font-mono text-slate-400"></div>
          </div>

          <!-- Result Display -->
          <div id="viz-result-container" class="hidden card-elevated rounded-xl p-5 space-y-4">
            <h2 class="text-sm font-semibold text-slate-200 flex items-center gap-2">
              <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              Generated Visualization
            </h2>
            
            <div class="flex justify-center">
              <img id="viz-result-image" class="max-w-full rounded-lg shadow-2xl border border-slate-600" alt="Generated visualization" />
            </div>
            
            <div class="flex justify-center gap-3">
              <button id="btn-download-viz" class="px-4 py-2 rounded-lg text-sm font-medium bg-green-600/20 hover:bg-green-600/30 border border-green-500/50 text-green-300 transition-colors flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                Download Image
              </button>
              <button id="btn-regenerate-viz" class="px-4 py-2 rounded-lg text-sm font-medium bg-accentPurple/20 hover:bg-accentPurple/30 text-accentPurple transition-colors flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Regenerate
              </button>
            </div>
            
            <details class="mt-4">
              <summary class="text-xs text-slate-400 cursor-pointer hover:text-slate-300">View generated prompt</summary>
              <pre id="viz-prompt-display" class="mt-2 p-3 rounded bg-slate-900/50 text-xs text-slate-400 overflow-x-auto whitespace-pre-wrap"></pre>
            </details>
          </div>

        </div>
      </section>

      <!-- View: Editor -->
      <section id="view-editor" class="flex-1 flex flex-col hidden">
        <div
          class="px-6 py-3 border-b borderSoft flex items-center justify-between bg-slate-950/50">
          <div class="flex items-center gap-3">
            <input id="template-name"
              class="text-sm font-mono text-accentCyan border-none focus:outline-none bg-transparent px-0 py-0"
              value="template_name" />
            <span id="template-meta"
              class="text-[0.65rem] font-mono text-slate-500"></span>
          </div>
          <div class="flex items-center gap-3 text-[0.7rem] font-mono">
            <label class="flex items-center gap-1 text-slate-400">
              <input type="checkbox" id="toggle-full-json"
                class="rounded border-slate-500 bg-slate-900/60" />
              <span>Full JSON</span>
            </label>
            <button id="btn-add-category"
              class="px-3 py-1.5 rounded-md border border-slate-600 text-slate-300 hover:bg-slate-800 text-xs flex items-center gap-1">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
              Add Category
            </button>
            <button id="btn-save-template"
              class="px-3 py-1.5 rounded-md bg-gradient-to-r from-accentPurple to-accentCyan text-slate-50 hover:brightness-110 shadow-neon text-xs">
              Save to library
            </button>
          </div>
        </div>

        <div class="flex-1 overflow-auto px-6 py-4">
          <div id="editor-sections"
            class="grid grid-cols-1 lg:grid-cols-2 gap-4 pr-2 pb-8">
            <!-- injected -->
            </div>


          <div id="full-json-container" class="mt-6 hidden">
            <h2 class="text-xs font-mono text-slate-300 mb-1">
              FULL SCHEMA JSON
            </h2>
            <pre id="full-json"
              class="text-[0.7rem] font-mono bg-slate-950 text-slate-100 rounded-lg p-3 overflow-auto max-h-[320px] border borderSoft"></pre>
          </div>
        </div>
      </section>

      <!-- Category Edit Modal -->
      <div id="category-edit-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/70 backdrop-blur-sm">
        <div class="bg-slate-900 border border-slate-700 rounded-xl w-full max-w-2xl max-h-[80vh] overflow-hidden shadow-2xl">
          <div class="px-5 py-4 border-b border-slate-700 flex items-center justify-between">
            <div>
              <h3 id="modal-category-title" class="text-sm font-semibold text-slate-100">Edit Category</h3>
              <p class="text-xs text-slate-400 mt-0.5">Modify fields and structure</p>
            </div>
            <button id="modal-close" class="p-1.5 hover:bg-slate-800 rounded-lg text-slate-400 hover:text-slate-200">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          <div id="modal-content" class="p-5 overflow-y-auto max-h-[60vh]">
            <!-- Dynamic content -->
          </div>
          <div class="px-5 py-4 border-t border-slate-700 flex justify-end gap-3">
            <button id="modal-cancel" class="px-4 py-2 text-xs text-slate-400 hover:text-slate-200">Cancel</button>
            <button id="modal-save" class="px-4 py-2 rounded-lg bg-accentCyan text-slate-900 text-xs font-medium hover:brightness-110">Save Changes</button>
          </div>
        </div>
      </div>

    </div>
  </main>

    <script>
    // ----- Global state -----
    let currentView = "question";
    let templates = [];
    let currentTemplate = null; // {id, name, question, createdAt, schema}
    let schemaJSON = null;
    let sectionExpanded = {}; // key -> bool
    let showFullJSON = false;

    // Auto-detect API base URL: use localhost for local dev (including file://), or production URL
    const isLocal = !window.location.hostname || window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1";
    const API_BASE = isLocal
      ? "http://127.0.0.1:8000"
      : "https://knowledge-cards-production.up.railway.app";
    
    console.log("[DEBUG] hostname:", window.location.hostname, "| isLocal:", isLocal, "| API_BASE:", API_BASE);

    // ----- Session ID for user isolation -----
    function getSessionId() {
      let sessionId = localStorage.getItem('kc_session_id');
      if (!sessionId) {
        // Generate a short unique ID: 8 chars
        sessionId = 'u' + Math.random().toString(36).substring(2, 9);
        localStorage.setItem('kc_session_id', sessionId);
        console.log("[SESSION] Created new session:", sessionId);
      }
      return sessionId;
    }
    
    const SESSION_ID = getSessionId();
    console.log("[SESSION] Using session ID:", SESSION_ID);
    
    // Helper to add session prefix to folder names
    function sessionFolder(folderName) {
      // Don't double-prefix if already has session ID
      if (folderName.startsWith(SESSION_ID + '_')) return folderName;
      return `${SESSION_ID}_${folderName}`;
    }
    
    // Helper to strip session prefix for display
    function displayFolder(folderName) {
      if (folderName.startsWith(SESSION_ID + '_')) {
        return folderName.substring(SESSION_ID.length + 1);
      }
      return folderName;
    }
    
    // Check if a folder/file belongs to current session
    function isMySession(name) {
      return name.startsWith(SESSION_ID + '_');
    }

    // ----- DOM helpers -----
    function $(id) {
      return document.getElementById(id);
    }

    function setView(view) {
      currentView = view;
      ["view-welcome", "view-question", "view-templates", "view-runs", "view-visualize", "view-editor"].forEach(
        (vid) => {
          $(vid).classList.toggle("hidden", vid !== "view-" + view);
        }
      );

      const mapping = {
        welcome: "nav-welcome",
        question: "nav-question",
        templates: "nav-templates",
        runs: "nav-runs",
        visualize: "nav-visualize",
        editor: "nav-editor",
      };

      Object.keys(mapping).forEach((v) => {
        const btn = $(mapping[v]);
        if (!btn) return;
        if (v === view) {
          btn.classList.add("nav-active");
          btn.classList.remove("nav-idle");
        } else {
          btn.classList.remove("nav-active");
          if (v !== "editor" || currentTemplate) {
            btn.classList.add("nav-idle");
          }
        }
      });

      if (view === "templates") renderTemplatesView();
      if (view === "editor") renderEditorView();
    }

    function prettyDate(iso) {
      return new Date(iso).toLocaleString();
    }

    function downloadJSON(filename, data) {
      const blob = new Blob([JSON.stringify(data, null, 2)], {
        type: "application/json",
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ---------- Backend helpers ----------

    async function apiGenerateSchemaFromQuestion(question, pointers, model) {
      console.log("[api] generate schema for question:", question, pointers, "model:", model);

      const response = await fetch(`${API_BASE}/schema_from_question`, {
        method: "POST",
        mode: "cors",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          question,
          model: model || "gemini-2.5-flash-lite",
          pointers: {
            emphasize_conceptual: !!pointers.conceptual,
            include_empirical_methods: !!pointers.empirical,
            include_metaphysical_and_poetic: !!pointers.metapoetic,
            include_ethics_context: !!pointers.ethics,
          },
        }),
      });

      if (!response.ok) {
        const text = await response.text();
        console.error("API error:", response.status, text);
        throw new Error(`API error ${response.status}: ${text}`);
      }

      const data = await response.json();
      return data.schema; // schema object
    }

    async function apiSaveSchema(name, schema) {
      const res = await fetch(`${API_BASE}/save_schema`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, schema }),
      });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(`Save schema error ${res.status}: ${text}`);
      }
      return res.json(); // {ok, filename}
    }

    async function apiListSchemas() {
      const res = await fetch(`${API_BASE}/schemas`);
      if (!res.ok) throw new Error("Failed to list schemas");
      return res.json(); // {schemas: [...]}
    }

    async function apiListPapersFolders() {
      const res = await fetch(`${API_BASE}/papers_folders`);
      if (!res.ok) throw new Error("Failed to list papers folders");
      return res.json(); // {folders: [...]}
    }

    async function apiListResults() {
      const res = await fetch(`${API_BASE}/list_results`);
      if (!res.ok) throw new Error("Failed to list results");
      return res.json(); // {results: [{name, type, size}, ...]}
    }

    async function apiUploadPapers(folderName, files) {
      const formData = new FormData();
      for (const file of files) {
        formData.append("files", file);
      }
      const res = await fetch(`${API_BASE}/upload_papers/${encodeURIComponent(folderName)}`, {
        method: "POST",
        body: formData,
      });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(`Upload error ${res.status}: ${text}`);
      }
      return res.json(); // {ok, folder, uploaded: [...]}
    }

    async function apiRunGemini(schemaName, papersSubdir) {
      const res = await fetch(`${API_BASE}/run_gemini`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          schema_name: schemaName,
          papers_subdir: papersSubdir,
        }),
      });
      const data = await res.json();
      if (!res.ok) {
        throw new Error(data.detail || "Failed to run Gemini");
      }
      return data; // {ok, jsonl, csv}
    }

    // SSE-based streaming API for real-time progress using fetch (works cross-origin)
    async function apiRunGeminiWithProgress(schemaName, papersSubdir, model, onProgress) {
      const url = `${API_BASE}/run_gemini_stream?schema_name=${encodeURIComponent(schemaName)}&papers_subdir=${encodeURIComponent(papersSubdir)}&model=${encodeURIComponent(model || 'gemini-2.5-flash-lite')}`;
      
      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Accept': 'text/event-stream',
        },
      });
      
      if (!response.ok) {
        throw new Error(`Server error: ${response.status}`);
      }
      
      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';
      let result = null;
      
      console.log("[SSE] Starting stream read...");
      
      while (true) {
        const { done, value } = await reader.read();
        
        if (done) {
          console.log("[SSE] Stream ended");
          break;
        }
        
        buffer += decoder.decode(value, { stream: true });
        
        // Process complete SSE messages
        const lines = buffer.split('\n');
        buffer = lines.pop() || ''; // Keep incomplete line in buffer
        
        for (const line of lines) {
          if (line.startsWith('data: ')) {
            try {
              const data = JSON.parse(line.slice(6));
              console.log("[SSE] Received:", data);
              
              if (data.type === 'keepalive') {
                continue;
              }
              
              if (data.type === 'error') {
                throw new Error(data.message);
              }
              
              if (data.type === 'complete') {
                result = {
                  ok: true,
                  schema_name: data.schema_name,
                  papers_folder: data.papers_folder,
                  jsonl: data.jsonl,
                  csv: data.csv,
                  pdf: data.pdf,
                };
                continue;
              }
              
              // Progress update
              if (onProgress && data.stage) {
                onProgress(data);
              }
            } catch (e) {
              if (e.message && !e.message.includes('JSON')) {
                throw e; // Re-throw non-JSON errors
              }
              console.warn("Error parsing SSE data:", e);
            }
          }
        }
      }
      
      if (!result) {
        throw new Error("Stream ended without completion");
      }
      
      return result;
    }

    async function loadTemplatesFromBackend() {
      const res = await fetch(`${API_BASE}/list_templates`);
      if (!res.ok) return;
      const data = await res.json();
      templates = data.templates || [];
    }

    // ----- Question view logic -----
    let generating = false;

    async function handleGenerateTemplate() {
      if (generating) return;
      const q = $("question-input").value.trim();
      if (!q) return;

      generating = true;
      $("btn-generate").textContent = "Generating template‚Ä¶";
      $("btn-generate").classList.add("opacity-60", "cursor-wait");
      $("question-status").textContent = "Calling backend‚Ä¶";

      const options = {
        conceptual: $("opt-conceptual").checked,
        empirical: $("opt-empirical").checked,
        metapoetic: $("opt-metapoetic").checked,
        ethics: $("opt-ethics").checked,
      };
      
      const model = $("template-model").value || "gemini-2.5-flash-lite";

      try {
        const schema = await apiGenerateSchemaFromQuestion(q, options, model);
        schemaJSON = schema;
        sectionExpanded = {};
        showFullJSON = false;
        const now = new Date().toISOString();

        currentTemplate = {
          id: "tmp_" + Date.now(),
          name: "new_template_from_question",
          createdAt: now,
          question: q,
          schema: schema,
        };

        $("nav-editor").classList.remove("hidden");
        $("btn-open-current-from-question").classList.remove("hidden");
        $("btn-open-current-from-library").classList.remove("hidden");

        $("question-status").textContent = "Template generated. Opening editor‚Ä¶";
        setView("editor");
      } catch (err) {
        console.error(err);
        $("question-status").textContent =
          "Error generating template (see console).";
      }

      generating = false;
      $("btn-generate").textContent = "Generate template";
      $("btn-generate").classList.remove("opacity-60", "cursor-wait");
    }

    // ----- Templates library view -----
    function renderTemplatesView() {
      const listEl = $("templates-list");
      const emptyEl = $("templates-empty");

      if (!templates.length) {
        emptyEl.classList.remove("hidden");
        listEl.classList.add("hidden");
        listEl.innerHTML = "";
        return;
      }

      emptyEl.classList.add("hidden");
      listEl.classList.remove("hidden");
      listEl.innerHTML = "";

      templates.forEach((t) => {
        const card = document.createElement("div");
        card.className =
          "glass-soft border borderSoft rounded-lg px-4 py-3 flex items-start justify-between gap-4";

        const left = document.createElement("div");
        const nameDiv = document.createElement("div");
        nameDiv.className = "text-sm font-mono text-accentCyan";
        nameDiv.textContent = t.name;
        left.appendChild(nameDiv);

        const dateDiv = document.createElement("div");
        dateDiv.className = "text-[0.65rem] font-mono text-slate-500";
        dateDiv.textContent = "created: " + prettyDate(t.createdAt);
        left.appendChild(dateDiv);

        if (t.question) {
          const qDiv = document.createElement("div");
          qDiv.className = "mt-1 text-[0.7rem] text-slate-300 line-clamp-2";
          qDiv.innerHTML =
            "<span class='font-mono text-slate-400'>Q:</span> " + t.question;
          left.appendChild(qDiv);
        }

        const right = document.createElement("div");
        right.className =
          "flex flex-col items-end gap-1.5 text-[0.7rem] font-mono";

        const btnOpen = document.createElement("button");
        btnOpen.className =
          "px-2.5 py-1 rounded-md bg-slate-900 text-slate-100 border borderSoft hover:bg-slate-800";
        btnOpen.textContent = "Open";
        btnOpen.onclick = () => {
          currentTemplate = { ...t };
          schemaJSON = structuredClone(t.schema);
          sectionExpanded = {};
          showFullJSON = false;
          $("nav-editor").classList.remove("hidden");
          $("btn-open-current-from-question").classList.remove("hidden");
          $("btn-open-current-from-library").classList.remove("hidden");
          setView("editor");
        };
        right.appendChild(btnOpen);

        const btnDup = document.createElement("button");
        btnDup.className =
          "px-2.5 py-1 rounded-md border borderSoft hover:bg-slate-900 text-slate-200";
        btnDup.textContent = "Duplicate";
        btnDup.onclick = () => {
          const copy = {
            ...t,
            id: "tmp_" + Date.now(),
            name: t.name + "_copy",
            createdAt: new Date().toISOString(),
          };
          templates.push(copy);
          renderTemplatesView();
        };
        right.appendChild(btnDup);

        const btnExport = document.createElement("button");
        btnExport.className =
          "px-2.5 py-1 rounded-md border borderSoft hover:bg-slate-900 text-slate-200";
        btnExport.textContent = "Export JSON";
        btnExport.onclick = () =>
          downloadJSON((t.name || "template") + ".json", t.schema);
        right.appendChild(btnExport);

        card.appendChild(left);
        card.appendChild(right);
        listEl.appendChild(card);
      });
    }

    async function saveCurrentTemplate() {
      if (!currentTemplate || !schemaJSON) return;

      const nameInput = $("template-name");
      const name =
        nameInput.value.trim() ||
        currentTemplate.name ||
        "unnamed_template_" + Date.now();

      const existingIdx = templates.findIndex((t) => t.id === currentTemplate.id);
      const updated = {
        ...currentTemplate,
        name,
        schema: schemaJSON,
        createdAt: currentTemplate.createdAt || new Date().toISOString(),
      };

      if (existingIdx >= 0) {
        templates[existingIdx] = updated;
      } else {
        templates.push(updated);
      }
      currentTemplate = updated;

      try {
        const resp = await apiSaveSchema(name, schemaJSON);
        console.log("Schema saved as", resp.filename);
        alert(`Template saved and written to cards/${resp.filename}`);
      } catch (err) {
        console.error(err);
        alert(
          "Template saved locally, but failed to write to cards/ (see console)."
        );
      }

      renderTemplatesView();
    }

    // ----- Editor view -----
    function renderEditorView() {
      if (!currentTemplate || !schemaJSON) {
        $("editor-sections").innerHTML = `
          <div class="max-w-3xl mx-auto py-8">
            <h1 class="text-xl font-semibold text-slate-100 mb-2">
              Template editor
            </h1>
            <p class="text-sm text-slate-400">
              No template selected. Generate one from a question,
              or open one from the library.
            </p>
          </div>`;
        return;
      }

      $("template-name").value = currentTemplate.name || "template_name";
      $("template-meta").textContent =
        "(created " + prettyDate(currentTemplate.createdAt) + ")";
      $("toggle-full-json").checked = showFullJSON;

      const container = $("editor-sections");
      container.innerHTML = "";

      const topKeys = Object.keys(schemaJSON);

      topKeys.forEach((key) => {
        const value = schemaJSON[key];
        const isObject = value && typeof value === "object" && !Array.isArray(value);
        const isArray = Array.isArray(value);

        if (!sectionExpanded.hasOwnProperty(key)) {
          sectionExpanded[key] = true;
        }

        const card = document.createElement("div");
        card.className = "category-card glass-soft border borderSoft rounded-xl flex flex-col overflow-hidden transition-all hover:border-slate-600";
        card.dataset.key = key;

        // Header with controls
        const header = document.createElement("div");
        header.className = "px-4 py-3 bg-gradient-to-r from-slate-800/50 to-slate-900/50 flex items-center justify-between";

        const leftSide = document.createElement("div");
        leftSide.className = "flex items-center gap-3";

        // Category icon
        const iconSpan = document.createElement("span");
        iconSpan.className = "text-lg";
        iconSpan.textContent = getCategoryIcon(key);
        leftSide.appendChild(iconSpan);

        // Category name (editable on double-click)
        const nameContainer = document.createElement("div");
        const labelSpan = document.createElement("span");
        labelSpan.className = "text-sm font-medium text-slate-100 cursor-pointer hover:text-accentCyan transition-colors";
        labelSpan.textContent = key.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase());
        labelSpan.title = "Double-click to rename";
        labelSpan.ondblclick = () => renameCategoryPrompt(key);
        nameContainer.appendChild(labelSpan);
        
        // Field count badge
        const fieldCount = isObject ? Object.keys(value).length : (isArray ? value.length : 1);
        const countBadge = document.createElement("span");
        countBadge.className = "ml-2 text-[0.6rem] px-1.5 py-0.5 rounded-full bg-slate-700 text-slate-400";
        countBadge.textContent = `${fieldCount} ${isObject ? 'fields' : (isArray ? 'items' : 'value')}`;
        nameContainer.appendChild(countBadge);
        
        leftSide.appendChild(nameContainer);
        header.appendChild(leftSide);

        // Action buttons
        const actions = document.createElement("div");
        actions.className = "flex items-center gap-1";

        // Edit button
        const editBtn = document.createElement("button");
        editBtn.className = "p-1.5 rounded-lg hover:bg-slate-700/50 text-slate-400 hover:text-accentCyan transition-colors";
        editBtn.title = "Edit category";
        editBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>`;
        editBtn.onclick = () => openCategoryModal(key, value);
        actions.appendChild(editBtn);

        // Toggle expand button
        const toggleBtn = document.createElement("button");
        toggleBtn.className = "p-1.5 rounded-lg hover:bg-slate-700/50 text-slate-400 hover:text-slate-200 transition-colors";
        toggleBtn.innerHTML = sectionExpanded[key] 
          ? `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/></svg>`
          : `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>`;
        toggleBtn.onclick = () => {
          sectionExpanded[key] = !sectionExpanded[key];
          renderEditorView();
        };
        actions.appendChild(toggleBtn);

        // Delete button
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "p-1.5 rounded-lg hover:bg-red-900/30 text-slate-400 hover:text-red-400 transition-colors";
        deleteBtn.title = "Remove category";
        deleteBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>`;
        deleteBtn.onclick = () => deleteCategoryConfirm(key);
        actions.appendChild(deleteBtn);

        header.appendChild(actions);
        card.appendChild(header);

        // Body - visual preview of fields
        if (sectionExpanded[key]) {
          const body = document.createElement("div");
          body.className = "px-4 py-3 space-y-2";

          if (isObject) {
            // Show fields as tags/chips
            const fieldsContainer = document.createElement("div");
            fieldsContainer.className = "flex flex-wrap gap-2";

            Object.entries(value).forEach(([fieldKey, fieldVal]) => {
              const chip = document.createElement("div");
              chip.className = "field-chip group flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg bg-slate-800/70 border border-slate-700 hover:border-slate-500 transition-all cursor-pointer";
              chip.onclick = () => openCategoryModal(key, value, fieldKey);

              const fieldIcon = document.createElement("span");
              fieldIcon.className = "text-xs";
              fieldIcon.textContent = getFieldIcon(fieldVal);
              chip.appendChild(fieldIcon);

              const fieldName = document.createElement("span");
              fieldName.className = "text-xs text-slate-300 group-hover:text-slate-100";
              fieldName.textContent = fieldKey.replace(/_/g, " ");
              chip.appendChild(fieldName);

              // Type indicator
              const typeIndicator = document.createElement("span");
              typeIndicator.className = "text-[0.6rem] text-slate-500 ml-1";
              typeIndicator.textContent = getFieldTypeLabel(fieldVal);
              chip.appendChild(typeIndicator);

              fieldsContainer.appendChild(chip);
            });

            body.appendChild(fieldsContainer);
          } else if (isArray) {
            const info = document.createElement("div");
            info.className = "text-xs text-slate-400 flex items-center gap-2";
            info.innerHTML = `<span class="text-slate-500">Array with ${value.length} items</span>
              <button class="text-accentCyan hover:underline" onclick="openCategoryModal('${key}', schemaJSON['${key}'])">Edit items</button>`;
            body.appendChild(info);
          } else {
            const info = document.createElement("div");
            info.className = "text-xs text-slate-400";
            info.textContent = `Value: ${typeof value === 'string' ? `"${value}"` : value}`;
            body.appendChild(info);
          }

          card.appendChild(body);
        }

        container.appendChild(card);
      });

      if (showFullJSON) {
        $("full-json-container").classList.remove("hidden");
        $("full-json").textContent = JSON.stringify(schemaJSON, null, 2);
      } else {
        $("full-json-container").classList.add("hidden");
      }
    }

    // Helper functions for the visual editor
    function getCategoryIcon(key) {
      const icons = {
        metadata: 'üìã', citation: 'üìã',
        orientation_and_scope: 'üéØ', core_focus: 'üéØ',
        findings: 'üî¨', findings_and_comparisons: 'üî¨',
        network_dynamics_facets: 'üï∏Ô∏è', biological_systems_analyzed: 'üåø',
        limitations: '‚ö†Ô∏è', limitations_and_future_directions: '‚ö†Ô∏è', limits: '‚ö†Ô∏è',
        methods: 'üîß', methods_and_metrics: 'üìè',
        theoretical_frameworks: 'üìê', theory: 'üìê',
        relational_analysis: 'üîó', phenomenology_definition: 'üßò',
        feedback_mechanisms_definition: 'üîÑ', core_thesis: 'üí°'
      };
      return icons[key] || 'üì¶';
    }

    function getFieldIcon(val) {
      if (Array.isArray(val)) return 'üìö';
      if (typeof val === 'object' && val !== null) return 'üóÇÔ∏è';
      if (typeof val === 'string') return 'üìù';
      if (typeof val === 'number') return 'üî¢';
      if (typeof val === 'boolean') return '‚úì';
      return '‚Ä¢';
    }

    function getFieldTypeLabel(val) {
      if (Array.isArray(val)) return `[${val.length}]`;
      if (typeof val === 'object' && val !== null) return `{${Object.keys(val).length}}`;
      if (typeof val === 'string' && val === '') return 'empty';
      return '';
    }

    function renameCategoryPrompt(oldKey) {
      const newKey = prompt('Enter new category name (use underscores for spaces):', oldKey);
      if (newKey && newKey !== oldKey && !schemaJSON.hasOwnProperty(newKey)) {
        const value = schemaJSON[oldKey];
        delete schemaJSON[oldKey];
        schemaJSON[newKey] = value;
        renderEditorView();
      }
    }

    function deleteCategoryConfirm(key) {
      if (confirm(`Delete category "${key.replace(/_/g, ' ')}"? This cannot be undone.`)) {
        delete schemaJSON[key];
        delete sectionExpanded[key];
        renderEditorView();
      }
    }

    let currentEditingCategory = null;
    let currentEditingData = null;

    function openCategoryModal(key, value, focusField = null) {
      currentEditingCategory = key;
      currentEditingData = JSON.parse(JSON.stringify(value)); // Deep clone
      
      const modal = $("category-edit-modal");
      const title = $("modal-category-title");
      const content = $("modal-content");
      
      title.textContent = key.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase());
      content.innerHTML = '';
      
      if (typeof value === 'object' && !Array.isArray(value)) {
        // Render editable fields
        Object.entries(value).forEach(([fieldKey, fieldVal]) => {
          const fieldContainer = document.createElement("div");
          fieldContainer.className = "field-editor mb-4 p-3 rounded-lg bg-slate-800/50 border border-slate-700";
          fieldContainer.dataset.fieldKey = fieldKey;
          
          // Field header
          const fieldHeader = document.createElement("div");
          fieldHeader.className = "flex items-center justify-between mb-2";
          
          const fieldLabel = document.createElement("span");
          fieldLabel.className = "text-xs font-medium text-slate-200";
          fieldLabel.textContent = fieldKey.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase());
          fieldHeader.appendChild(fieldLabel);
          
          const deleteFieldBtn = document.createElement("button");
          deleteFieldBtn.className = "text-xs text-red-400 hover:text-red-300";
          deleteFieldBtn.textContent = "Remove";
          deleteFieldBtn.onclick = () => {
            delete currentEditingData[fieldKey];
            fieldContainer.remove();
          };
          fieldHeader.appendChild(deleteFieldBtn);
          
          fieldContainer.appendChild(fieldHeader);
          
          // Field value editor
          const fieldEditor = createFieldEditor(fieldKey, fieldVal);
          fieldContainer.appendChild(fieldEditor);
          
          content.appendChild(fieldContainer);
        });
        
        // Add new field button
        const addFieldBtn = document.createElement("button");
        addFieldBtn.className = "w-full py-2 mt-2 border-2 border-dashed border-slate-600 rounded-lg text-xs text-slate-400 hover:text-slate-200 hover:border-slate-500 transition-colors";
        addFieldBtn.textContent = "+ Add new field";
        addFieldBtn.onclick = () => addNewFieldToModal(content);
        content.appendChild(addFieldBtn);
        
      } else if (Array.isArray(value)) {
        // Array editor
        const arrayInfo = document.createElement("div");
        arrayInfo.className = "text-xs text-slate-400 mb-3";
        arrayInfo.textContent = `Array with ${value.length} items. Edit the JSON below:`;
        content.appendChild(arrayInfo);
        
        const textarea = document.createElement("textarea");
        textarea.id = "modal-array-editor";
        textarea.className = "w-full text-xs font-mono border border-slate-600 rounded-lg px-3 py-2 bg-slate-950 text-slate-100 min-h-[200px] focus:outline-none focus:ring-1 focus:ring-accentCyan";
        textarea.value = JSON.stringify(value, null, 2);
        content.appendChild(textarea);
      } else {
        // Simple value
        const input = document.createElement("input");
        input.id = "modal-simple-editor";
        input.type = "text";
        input.className = "w-full text-xs border border-slate-600 rounded-lg px-3 py-2 bg-slate-950 text-slate-100 focus:outline-none focus:ring-1 focus:ring-accentCyan";
        input.value = value;
        content.appendChild(input);
      }
      
      modal.classList.remove("hidden");
      modal.classList.add("flex");
    }

    function createFieldEditor(fieldKey, fieldVal) {
      const wrapper = document.createElement("div");
      
      if (Array.isArray(fieldVal)) {
        // Array field - show as tag input
        const tagContainer = document.createElement("div");
        tagContainer.className = "flex flex-wrap gap-1.5 p-2 rounded bg-slate-900/50 min-h-[40px]";
        tagContainer.id = `field-${fieldKey}`;
        
        fieldVal.forEach((item, idx) => {
          const tag = document.createElement("span");
          tag.className = "inline-flex items-center gap-1 px-2 py-0.5 rounded bg-slate-700 text-xs text-slate-200";
          tag.textContent = typeof item === 'string' ? item : (item.description || item.name || JSON.stringify(item).substring(0, 30));
          
          const removeTag = document.createElement("button");
          removeTag.className = "text-slate-400 hover:text-red-400 ml-1";
          removeTag.innerHTML = "√ó";
          removeTag.onclick = () => {
            currentEditingData[fieldKey].splice(idx, 1);
            tag.remove();
          };
          tag.appendChild(removeTag);
          tagContainer.appendChild(tag);
        });
        
        const addInput = document.createElement("input");
        addInput.type = "text";
        addInput.placeholder = "Add item...";
        addInput.className = "flex-1 min-w-[100px] bg-transparent text-xs text-slate-300 outline-none";
        addInput.onkeydown = (e) => {
          if (e.key === 'Enter' && addInput.value.trim()) {
            currentEditingData[fieldKey].push(addInput.value.trim());
            const tag = document.createElement("span");
            tag.className = "inline-flex items-center gap-1 px-2 py-0.5 rounded bg-slate-700 text-xs text-slate-200";
            tag.textContent = addInput.value.trim();
            const removeTag = document.createElement("button");
            removeTag.className = "text-slate-400 hover:text-red-400 ml-1";
            removeTag.innerHTML = "√ó";
            removeTag.onclick = () => {
              const idx = currentEditingData[fieldKey].indexOf(addInput.value.trim());
              if (idx > -1) currentEditingData[fieldKey].splice(idx, 1);
              tag.remove();
            };
            tag.appendChild(removeTag);
            tagContainer.insertBefore(tag, addInput);
            addInput.value = '';
          }
        };
        tagContainer.appendChild(addInput);
        wrapper.appendChild(tagContainer);
        
      } else if (typeof fieldVal === 'object' && fieldVal !== null) {
        // Nested object - show as mini JSON editor
        const textarea = document.createElement("textarea");
        textarea.className = "w-full text-[0.65rem] font-mono border border-slate-600 rounded px-2 py-1.5 bg-slate-950 text-slate-100 min-h-[80px] focus:outline-none focus:ring-1 focus:ring-accentCyan";
        textarea.value = JSON.stringify(fieldVal, null, 2);
        textarea.onblur = () => {
          try {
            currentEditingData[fieldKey] = JSON.parse(textarea.value);
          } catch (e) {
            // Invalid JSON, revert
            textarea.value = JSON.stringify(currentEditingData[fieldKey], null, 2);
          }
        };
        wrapper.appendChild(textarea);
        
      } else {
        // Simple value - input field
        const input = document.createElement("input");
        input.type = "text";
        input.className = "w-full text-xs border border-slate-600 rounded px-2 py-1.5 bg-slate-950 text-slate-100 focus:outline-none focus:ring-1 focus:ring-accentCyan";
        input.value = fieldVal || '';
        input.onchange = () => {
          currentEditingData[fieldKey] = input.value;
        };
        wrapper.appendChild(input);
      }
      
      return wrapper;
    }

    function addNewFieldToModal(content) {
      const fieldName = prompt('Enter field name (use underscores for spaces):');
      if (!fieldName) return;
      
      const fieldType = prompt('Field type: "string", "array", or "object"', 'string');
      let defaultValue;
      switch (fieldType) {
        case 'array': defaultValue = []; break;
        case 'object': defaultValue = {}; break;
        default: defaultValue = '';
      }
      
      currentEditingData[fieldName] = defaultValue;
      
      // Insert before the add button
      const addBtn = content.querySelector('button:last-child');
      const fieldContainer = document.createElement("div");
      fieldContainer.className = "field-editor mb-4 p-3 rounded-lg bg-slate-800/50 border border-slate-700";
      fieldContainer.dataset.fieldKey = fieldName;
      
      const fieldHeader = document.createElement("div");
      fieldHeader.className = "flex items-center justify-between mb-2";
      
      const fieldLabel = document.createElement("span");
      fieldLabel.className = "text-xs font-medium text-slate-200";
      fieldLabel.textContent = fieldName.replace(/_/g, " ").replace(/\b\w/g, c => c.toUpperCase());
      fieldHeader.appendChild(fieldLabel);
      
      const deleteFieldBtn = document.createElement("button");
      deleteFieldBtn.className = "text-xs text-red-400 hover:text-red-300";
      deleteFieldBtn.textContent = "Remove";
      deleteFieldBtn.onclick = () => {
        delete currentEditingData[fieldName];
        fieldContainer.remove();
      };
      fieldHeader.appendChild(deleteFieldBtn);
      
      fieldContainer.appendChild(fieldHeader);
      fieldContainer.appendChild(createFieldEditor(fieldName, defaultValue));
      
      content.insertBefore(fieldContainer, addBtn);
    }

    function closeCategoryModal() {
      const modal = $("category-edit-modal");
      modal.classList.add("hidden");
      modal.classList.remove("flex");
      currentEditingCategory = null;
      currentEditingData = null;
    }

    function saveCategoryModal() {
      if (!currentEditingCategory) return;
      
      // Check for array editor
      const arrayEditor = $("modal-array-editor");
      if (arrayEditor) {
        try {
          currentEditingData = JSON.parse(arrayEditor.value);
        } catch (e) {
          alert("Invalid JSON in array editor");
          return;
        }
      }
      
      // Check for simple editor
      const simpleEditor = $("modal-simple-editor");
      if (simpleEditor) {
        currentEditingData = simpleEditor.value;
      }
      
      schemaJSON[currentEditingCategory] = currentEditingData;
      closeCategoryModal();
      renderEditorView();
    }

    function addNewCategory() {
      const name = prompt('Enter category name (use underscores for spaces):');
      if (!name) return;
      
      if (schemaJSON.hasOwnProperty(name)) {
        alert('Category already exists');
        return;
      }
      
      // Create with default structure
      schemaJSON[name] = {
        description: "",
        key_points: []
      };
      
      sectionExpanded[name] = true;
      renderEditorView();
      
      // Open modal to edit immediately
      openCategoryModal(name, schemaJSON[name]);
    }

    // ----- Runs & reports -----
    async function refreshRunOptions() {
      try {
        const [schemasRes, foldersRes] = await Promise.all([
          apiListSchemas(),
          apiListPapersFolders(),
        ]);

        const schemaSelect = $("run-schema");
        const folderSelect = $("run-folder");

        // clear, keep first placeholder option
        schemaSelect.options.length = 1;
        folderSelect.options.length = 1;

        schemasRes.schemas.forEach((name) => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          schemaSelect.appendChild(opt);
        });

        // Filter folders to only show current session's folders (online) or all (local)
        foldersRes.folders.forEach((folder) => {
          // In production, only show folders belonging to this session
          if (!isLocal && !isMySession(folder)) return;
          
          const opt = document.createElement("option");
          opt.value = folder;
          // Display without session prefix
          opt.textContent = isLocal ? folder : displayFolder(folder);
          folderSelect.appendChild(opt);
        });
      } catch (err) {
        console.error("Failed to refresh run options", err);
        $("run-status").textContent =
          "Error loading schemas/folders (see console).";
      }
    }

    async function handleRunGemini() {
        const schemaName = $("run-schema").value;
        const folder = $("run-folder").value;
        const model = $("run-model").value || "gemini-2.5-flash-lite";
        const statusEl = $("run-status");
        const outEl = $("run-output");
        const btnText = $("btn-text");
        const btnIconDefault = $("btn-icon-default");
        const btnIconLoading = $("btn-icon-loading");
        const progressContainer = $("progress-container");
        const progressBar = $("progress-bar");
        const progressLabel = $("progress-label");
        const progressPercent = $("progress-percent");
        const btn = $("btn-run-gemini");

        if (!schemaName || !folder) {
            statusEl.textContent = "‚ö†Ô∏è Select both a schema and a papers folder.";
            return;
        }

        // UI: show loading state
        btn.disabled = true;
        btn.classList.add("opacity-75", "cursor-wait");
        btnText.textContent = "Building...";
        btnIconDefault.classList.add("hidden");
        btnIconLoading.classList.remove("hidden");
        progressContainer.classList.remove("hidden");
        progressBar.style.width = "0%";
        progressLabel.textContent = "Initializing...";
        progressPercent.textContent = "0%";
        statusEl.textContent = "";
        outEl.textContent = "";

        // Progress handler for real-time updates
        function handleProgress(data) {
            const { stage, current, total, message, percent } = data;
            
            // Calculate overall progress based on stage
            let overallPercent = 0;
            switch (stage) {
                case 'init':
                    overallPercent = 5;
                    break;
                case 'loading':
                    overallPercent = 10;
                    break;
                case 'cards':
                    // Cards processing is 10-70% of overall progress
                    overallPercent = 10 + Math.round((current / total) * 60);
                    break;
                case 'saving':
                    // Saving is 70-85%
                    overallPercent = 70 + Math.round((current / total) * 15);
                    break;
                case 'meta':
                    // Meta-card is 85-98%
                    overallPercent = 85 + Math.round((current / total) * 13);
                    break;
                case 'complete':
                    overallPercent = 100;
                    break;
                default:
                    overallPercent = percent || 0;
            }
            
            progressBar.style.width = overallPercent + "%";
            progressLabel.textContent = message;
            progressPercent.textContent = overallPercent + "%";
        }

        try {
            const res = await apiRunGeminiWithProgress(schemaName, folder, model, handleProgress);
            
            // Complete progress
            progressBar.style.width = "100%";
            progressLabel.textContent = "Complete!";
            progressPercent.textContent = "100%";

            setTimeout(() => {
              progressContainer.classList.add("hidden");
            }, 1500);

            statusEl.innerHTML = '<span class="text-green-400">‚úì Cards built successfully!</span>';

            // Build download links
            const jsonlName = res.jsonl.split('/').pop();
            const csvName = res.csv.split('/').pop();
            const pdfName = res.pdf.split('/').pop();

            outEl.innerHTML =
            `<div class="mt-3 p-4 rounded-lg bg-slate-900/50 border border-slate-700 space-y-2">
              <div><span class="text-slate-500">Schema:</span> <span class="text-accentCyan">${res.schema_name}</span></div>
              <div><span class="text-slate-500">Papers:</span> <span class="text-accentCyan">${res.papers_folder}</span></div>
              <div class="pt-2 border-t border-slate-700 space-y-1">
                <div class="flex items-center gap-2">
                  <span class="text-slate-500">üìÑ JSONL:</span>
                  <a href="${API_BASE}/download/results/${encodeURIComponent(jsonlName)}" target="_blank" class="text-accentPink hover:underline">${jsonlName}</a>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-slate-500">üìä CSV:</span>
                  <a href="${API_BASE}/download/results/${encodeURIComponent(csvName)}" target="_blank" class="text-accentPink hover:underline">${csvName}</a>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-slate-500">üìë PDF:</span>
                  <a href="${API_BASE}/download/results/${encodeURIComponent(pdfName)}" target="_blank" class="text-accentPink hover:underline">${pdfName}</a>
                </div>
              </div>
            </div>`;
            
            // Auto-refresh results list
            refreshResultsList();
        } catch (err) {
            progressContainer.classList.add("hidden");
            console.error(err);
            statusEl.innerHTML = '<span class="text-red-400">‚úó Error building cards: ' + err.message + '</span>';
            outEl.textContent = "";
        } finally {
            // Reset button state
            btn.disabled = false;
            btn.classList.remove("opacity-75", "cursor-wait");
            btnText.textContent = "Build Cards";
            btnIconDefault.classList.remove("hidden");
            btnIconLoading.classList.add("hidden");
        }
    }


    // ----- Wiring events -----
    window.addEventListener("DOMContentLoaded", async () => {
      await loadTemplatesFromBackend();

      $("nav-welcome").onclick = () => setView("welcome");
      $("nav-question").onclick = () => setView("question");
      $("nav-templates").onclick = () => setView("templates");
      $("nav-runs").onclick = () => {
        setView("runs");
        refreshRunOptions();
      };
      $("nav-visualize").onclick = () => {
        setView("visualize");
        loadVizResultFiles();
      };
      $("nav-editor").onclick = () => setView("editor");

      $("btn-generate").onclick = handleGenerateTemplate;
      $("btn-open-current-from-question").onclick = () => setView("editor");
      $("btn-open-current-from-library").onclick = () => setView("editor");

      $("btn-save-template").onclick = saveCurrentTemplate;
      $("btn-add-category").onclick = addNewCategory;
      $("template-name").addEventListener("change", (e) => {
        if (currentTemplate) {
          currentTemplate.name = e.target.value;
        }
      });
      $("toggle-full-json").addEventListener("change", (e) => {
        showFullJSON = e.target.checked;
        renderEditorView();
      });

      // Modal handlers
      $("modal-close").onclick = closeCategoryModal;
      $("modal-cancel").onclick = closeCategoryModal;
      $("modal-save").onclick = saveCategoryModal;
      $("category-edit-modal").onclick = (e) => {
        if (e.target.id === "category-edit-modal") closeCategoryModal();
      };

      $("btn-run-gemini").onclick = handleRunGemini;
      $("btn-refresh-folders").onclick = refreshRunOptions;
      $("btn-upload-papers").onclick = handleUploadPapers;
      $("btn-refresh-results").onclick = refreshResultsList;

      // Visualization handlers
      $("btn-load-card").onclick = loadCardForVisualization;
      $("btn-generate-viz").onclick = generateVisualization;
      $("btn-regenerate-viz").onclick = generateVisualization;
      $("btn-download-viz").onclick = downloadVisualization;
      
      // Meta-card selection clears individual selection
      $("viz-meta-cards").onchange = () => {
        if ($("viz-meta-cards").value) {
          $("viz-individual-files").value = "";
          $("viz-individual-cards").innerHTML = '<option value="">-- Select file first --</option>';
          $("viz-individual-cards").disabled = true;
        }
      };
      
      // Individual file selection clears meta-card and loads cards
      $("viz-individual-files").onchange = async () => {
        if ($("viz-individual-files").value) {
          $("viz-meta-cards").value = "";
          await loadIndividualCards();
        } else {
          $("viz-individual-cards").innerHTML = '<option value="">-- Select file first --</option>';
          $("viz-individual-cards").disabled = true;
        }
      };

      // Setup viz mode selection
      document.querySelectorAll('.viz-mode-option').forEach(opt => {
        opt.onclick = () => {
          document.querySelectorAll('.viz-mode-option').forEach(o => {
            o.classList.remove('viz-selected-cyan', 'viz-selected-purple', 'viz-selected-pink', 'viz-selected-green');
            o.classList.add('viz-unselected');
          });
          const colors = { schematic: 'cyan', intuitive: 'purple', network: 'pink', infographic: 'green' };
          const color = colors[opt.dataset.value] || 'cyan';
          opt.classList.remove('viz-unselected');
          opt.classList.add(`viz-selected-${color}`);
          $("viz-mode-value").value = opt.dataset.value;
        };
      });

      // Setup viz model selection
      document.querySelectorAll('.viz-model-option').forEach(opt => {
        opt.onclick = () => {
          document.querySelectorAll('.viz-model-option').forEach(o => {
            o.classList.remove('viz-selected-cyan');
            o.classList.add('viz-unselected');
          });
          opt.classList.remove('viz-unselected');
          opt.classList.add('viz-selected-cyan');
          $("viz-model-value").value = opt.dataset.value;
        };
      });

      // Show session ID in sidebar
      $("session-indicator").textContent = isLocal ? "local mode" : `session: ${SESSION_ID}`;

      // initial view
      setView("welcome");
    });

    // ----- Upload handler -----
    async function handleUploadPapers() {
      const folderNameRaw = $("upload-folder-name").value.trim();
      const filesInput = $("upload-files");
      const statusEl = $("upload-status");
      const btn = $("btn-upload-papers");
      
      if (!folderNameRaw) {
        statusEl.innerHTML = '<span class="text-yellow-400">Please enter a folder name</span>';
        return;
      }
      
      if (!filesInput.files || filesInput.files.length === 0) {
        statusEl.innerHTML = '<span class="text-yellow-400">Please select PDF files to upload</span>';
        return;
      }
      
      // Validate folder name (alphanumeric, underscores, hyphens only)
      if (!/^[a-zA-Z0-9_-]+$/.test(folderNameRaw)) {
        statusEl.innerHTML = '<span class="text-yellow-400">Folder name can only contain letters, numbers, underscores, and hyphens</span>';
        return;
      }
      
      // Add session prefix for online usage
      const folderName = isLocal ? folderNameRaw : sessionFolder(folderNameRaw);
      
      btn.disabled = true;
      btn.classList.add("opacity-50", "cursor-wait");
      statusEl.innerHTML = '<span class="text-slate-400">Uploading...</span>';
      
      try {
        const result = await apiUploadPapers(folderName, filesInput.files);
        const displayName = isLocal ? result.folder : displayFolder(result.folder);
        statusEl.innerHTML = `<span class="text-green-400">‚úì Uploaded ${result.uploaded.length} file(s) to "${displayName}"</span>`;
        
        // Clear inputs
        $("upload-folder-name").value = "";
        filesInput.value = "";
        
        // Refresh folder list
        await refreshRunOptions();
        
        // Auto-select the new folder (use full name with prefix)
        $("run-folder").value = folderName;
      } catch (err) {
        console.error("Upload error:", err);
        statusEl.innerHTML = `<span class="text-red-400">‚úó ${err.message}</span>`;
      } finally {
        btn.disabled = false;
        btn.classList.remove("opacity-50", "cursor-wait");
      }
    }

    // ----- Results list handler -----
    async function refreshResultsList() {
      const container = $("results-list");
      container.innerHTML = '<span class="text-slate-500">Loading...</span>';
      
      try {
        const data = await apiListResults();
        
        // Filter results to only show current session's files (online) or all (local)
        let results = data.results || [];
        if (!isLocal) {
          results = results.filter(f => f.name.includes(SESSION_ID + '_'));
        }
        
        if (results.length === 0) {
          container.innerHTML = '<span class="text-slate-500">No result files found. Run the pipeline to generate results.</span>';
          return;
        }
        
        // Group by base name (e.g., cards_networks__plant_cognition)
        const grouped = {};
        results.forEach(f => {
          // Extract base name without extension
          const baseName = f.name.replace(/\.(jsonl|csv|pdf|json)$/, '');
          if (!grouped[baseName]) grouped[baseName] = [];
          grouped[baseName].push(f);
        });
        
        let html = '<div class="space-y-3">';
        Object.keys(grouped).sort().reverse().forEach(baseName => {
          const files = grouped[baseName];
          // Display name without session prefix
          const displayName = isLocal ? baseName : baseName.replace(new RegExp(`_${SESSION_ID}_`), '_');
          html += `
            <div class="p-3 rounded-lg bg-slate-900/50 border border-slate-700">
              <div class="text-accentCyan mb-2 text-xs truncate" title="${displayName}">${displayName}</div>
              <div class="flex flex-wrap gap-2">
          `;
          files.forEach(f => {
            const icon = f.type === 'pdf' ? 'üìë' : f.type === 'csv' ? 'üìä' : f.type === 'jsonl' ? 'üìÑ' : 'üìÅ';
            const sizeKB = (f.size / 1024).toFixed(1);
            html += `
              <a href="${API_BASE}/download/results/${encodeURIComponent(f.name)}" 
                 target="_blank"
                 class="inline-flex items-center gap-1 px-2 py-1 rounded bg-slate-800 hover:bg-slate-700 text-slate-300 hover:text-white transition-colors">
                <span>${icon}</span>
                <span class="uppercase">${f.type}</span>
                <span class="text-slate-500">(${sizeKB}KB)</span>
              </a>
            `;
          });
          html += '</div></div>';
        });
        html += '</div>';
        
        container.innerHTML = html;
      } catch (err) {
        console.error("Failed to load results:", err);
        container.innerHTML = `<span class="text-red-400">Error loading results: ${err.message}</span>`;
      }
    }

    // ========== VISUALIZATION FUNCTIONS ==========
    let loadedCardData = null;
    let generatedImageData = null;
    let generatedPrompt = "";

    async function loadVizResultFiles() {
      const metaSelect = $("viz-meta-cards");
      const individualSelect = $("viz-individual-files");
      
      metaSelect.innerHTML = '<option value="">Loading...</option>';
      individualSelect.innerHTML = '<option value="">Loading...</option>';
      
      try {
        const data = await apiListResults();
        let results = data.results || [];
        
        // Filter to JSON/JSONL files only
        results = results.filter(f => f.name.endsWith('.json') || f.name.endsWith('.jsonl'));
        
        // Filter by session if online
        if (!isLocal) {
          results = results.filter(f => f.name.includes(SESSION_ID + '_'));
        }
        
        // Separate meta-cards (contain 'meta' in name and are .json/.jsonl) from individual cards
        const metaCards = results.filter(f => f.name.toLowerCase().includes('meta'));
        const individualFiles = results.filter(f => !f.name.toLowerCase().includes('meta') && f.name.endsWith('.jsonl'));
        
        // Populate meta-cards dropdown
        metaSelect.innerHTML = '<option value="">-- Select a meta-card --</option>';
        metaCards.forEach(f => {
          const displayName = isLocal ? f.name : f.name.replace(new RegExp(`_${SESSION_ID}_`), '_');
          const opt = document.createElement('option');
          opt.value = f.name;
          opt.textContent = displayName.replace(/_/g, ' ').replace('.json', '').replace('.jsonl', '');
          metaSelect.appendChild(opt);
        });
        
        // Populate individual files dropdown
        individualSelect.innerHTML = '<option value="">-- Select result file --</option>';
        individualFiles.forEach(f => {
          const displayName = isLocal ? f.name : f.name.replace(new RegExp(`_${SESSION_ID}_`), '_');
          const opt = document.createElement('option');
          opt.value = f.name;
          opt.textContent = displayName.replace(/_/g, ' ').replace('.jsonl', '');
          individualSelect.appendChild(opt);
        });
        
        if (metaCards.length === 0) {
          metaSelect.innerHTML = '<option value="">No meta-cards found</option>';
        }
        if (individualFiles.length === 0) {
          individualSelect.innerHTML = '<option value="">No result files found</option>';
        }
      } catch (err) {
        console.error("Failed to load result files:", err);
        metaSelect.innerHTML = '<option value="">Error loading files</option>';
        individualSelect.innerHTML = '<option value="">Error loading files</option>';
      }
    }

    async function loadIndividualCards() {
      const filename = $("viz-individual-files").value;
      const cardSelector = $("viz-individual-cards");
      
      if (!filename) {
        cardSelector.innerHTML = '<option value="">-- Select file first --</option>';
        cardSelector.disabled = true;
        return;
      }
      
      cardSelector.innerHTML = '<option value="">Loading cards...</option>';
      cardSelector.disabled = true;
      
      try {
        const response = await fetch(`${API_BASE}/download/results/${encodeURIComponent(filename)}`);
        const text = await response.text();
        
        // Parse JSONL - each line is a separate card
        const cards = text.trim().split('\n').map((line, i) => {
          try {
            const card = JSON.parse(line);
            const title = card.schema?.metadata?.title || card.metadata?.title || `Card ${i + 1}`;
            return { index: i, card, title };
          } catch { return null; }
        }).filter(Boolean);
        
        // Populate card selector
        cardSelector.innerHTML = '';
        cards.forEach(({ index, title }) => {
          const opt = document.createElement('option');
          opt.value = index;
          opt.textContent = title.length > 50 ? title.slice(0, 50) + '...' : title;
          cardSelector.appendChild(opt);
        });
        
        // Store cards data
        cardSelector.dataset.cards = JSON.stringify(cards);
        cardSelector.disabled = false;
      } catch (err) {
        console.error("Failed to load cards:", err);
        cardSelector.innerHTML = '<option value="">Error loading cards</option>';
      }
    }

    async function loadCardsFromResultFile() {
      // Deprecated - kept for compatibility
      await loadIndividualCards();
    }

    async function loadCardForVisualization() {
      const metaFile = $("viz-meta-cards").value;
      const individualFile = $("viz-individual-files").value;
      const preview = $("viz-card-preview");
      const categoriesPanel = $("viz-categories-panel");
      const categoriesList = $("viz-categories-list");
      
      let filename = metaFile || individualFile;
      let isMeta = !!metaFile;
      
      if (!filename) {
        alert("Please select a meta-card or an individual card first");
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/download/results/${encodeURIComponent(filename)}`);
        const text = await response.text();
        
        let card;
        if (isMeta) {
          // Load meta-card (could be JSON or JSONL with single entry)
          if (filename.endsWith('.jsonl')) {
            const lines = text.trim().split('\n');
            card = JSON.parse(lines[0]);
          } else {
            card = JSON.parse(text);
          }
        } else {
          // Load specific card from JSONL
          const cardIndex = parseInt($("viz-individual-cards").value) || 0;
          const lines = text.trim().split('\n');
          card = JSON.parse(lines[cardIndex]);
          // Unwrap schema if present
          if (card.schema) card = card.schema;
        }
        
        loadedCardData = card;
        loadedCardData._isMeta = isMeta;
        
        // Show preview
        const title = card.metadata?.title || 'Untitled';
        const domain = card.orientation_and_scope?.main_domain || card.biological_systems_analyzed?.lifeform_categories?.join(', ') || '';
        const hasMetaMarkers = card.papers_covered || card.synthesis_metadata;
        
        $("viz-card-title").textContent = title;
        $("viz-card-type-badge").textContent = isMeta || hasMetaMarkers ? 'Meta-Card' : 'Paper Card';
        $("viz-card-type-badge").className = `text-xs px-2 py-0.5 rounded ${isMeta ? 'bg-accentPink/20 text-accentPink' : 'bg-accentCyan/20 text-accentCyan'}`;
        $("viz-card-summary").textContent = `${domain}${domain ? ' ‚Ä¢ ' : ''}${card.metadata?.keywords?.slice(0, 5).join(', ') || ''}`;
        preview.classList.remove("hidden");
        
        // Populate categories
        populateCategorySelector(card);
        categoriesPanel.classList.remove("hidden");
        
      } catch (err) {
        console.error("Failed to load card:", err);
        alert("Error loading card: " + err.message);
      }
    }

    // Category display names mapping - comprehensive across all card types
    const categoryDisplayNames = {
      // Common fields
      metadata: 'üìã Metadata',
      orientation_and_scope: 'üéØ Orientation & Scope',
      findings_and_comparisons: 'üî¨ Findings & Comparisons',
      
      // Network/plant cards
      network_dynamics_facets: 'üï∏Ô∏è Network Dynamics',
      biological_systems_analyzed: 'üåø Biological Systems',
      drivers_of_change: '‚ö° Drivers of Change',
      methods_and_metrics: 'üìè Methods & Metrics',
      limitations_and_future_directions: '‚ö†Ô∏è Limitations & Future',
      
      // Phenomenology cards
      core_thesis: 'üí° Core Thesis',
      feedback_mechanisms_definition: 'üîÑ Feedback Mechanisms',
      phenomenology_definition: 'üßò Phenomenology Definition',
      relational_analysis: 'üîó Relational Analysis',
      theoretical_frameworks: 'üìê Theoretical Frameworks',
      empirical_evidence_or_models: 'üî¨ Empirical Evidence',
      limitations_and_open_questions: '‚ùì Limitations & Questions',
      
      // Perception/creativity cards
      cognitive_and_phenomenological_aspects: 'üß† Cognitive Aspects',
      creative_and_artistic_dimensions: 'üé® Creative Dimensions',
      
      // Meta-card fields
      synthesis_metadata: 'üìä Synthesis Info',
      papers_covered: 'üìö Papers Covered',
      emergent_themes: '‚ú® Emergent Themes',
      cross_cutting_patterns: 'üîó Cross-cutting Patterns',
      methodological_synthesis: 'üîß Methodological Synthesis',
      theoretical_integration: 'üìê Theoretical Integration',
      practical_applications: 'üí° Practical Applications',
      research_gaps: '‚ùì Research Gaps',
      future_directions: 'üöÄ Future Directions',
      
      // Concept invention cards
      conceptual_framing: 'üí≠ Conceptual Framing',
      categories_of_word_invention: 'üìù Word Invention Categories',
      derivation_process_analysis: 'üîß Derivation Process',
      interdisciplinary_connections: 'üåê Interdisciplinary Links',
      
      // Science poetry cards
      poetry_of_science_dimensions: 'üé≠ Poetry of Science',
      scientific_foundations: 'üî¨ Scientific Foundations',
      
      // Dream language cards
      core_focus: 'üéØ Core Focus',
      language_and_meaning: 'üí¨ Language & Meaning',
      ambiguity_and_multistability: 'üîÆ Ambiguity & Multistability',
      dreams_and_imagery: 'üí≠ Dreams & Imagery',
      integration_points: 'üîó Integration Points',
      findings_or_claims: 'üìä Findings & Claims',
      
      // Basic schema cards
      citation: 'üìã Citation',
      problem: '‚ùì Problem',
      theory: 'üìê Theory',
      methods: 'üîß Methods',
      findings: 'üî¨ Findings',
      limits: '‚ö†Ô∏è Limitations',
      embodiment_facets: 'ü´Ä Embodiment Facets',
      notable_quotes: 'üí¨ Notable Quotes',
      open_questions: '‚ùì Open Questions'
    };

    function populateCategorySelector(card) {
      const categoriesList = $("viz-categories-list");
      const selectAllCheckbox = $("viz-select-all-categories");
      
      // Get top-level categories that have content
      const categories = Object.keys(card).filter(key => {
        // Skip internal/meta keys
        if (key.startsWith('_')) return false;
        // Skip empty values
        const val = card[key];
        if (val === null || val === undefined) return false;
        if (typeof val === 'object' && Object.keys(val).length === 0) return false;
        if (Array.isArray(val) && val.length === 0) return false;
        return true;
      });
      
      // Build checkboxes
      categoriesList.innerHTML = categories.map(cat => {
        const displayName = categoryDisplayNames[cat] || cat.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        return `
          <label class="viz-category-item flex items-center gap-2 p-2 rounded bg-slate-800/50 hover:bg-slate-700/50 cursor-pointer text-xs text-slate-300 transition-colors">
            <input type="checkbox" class="viz-category-checkbox w-3.5 h-3.5 rounded border-slate-500 bg-slate-800 text-accentCyan focus:ring-accentCyan/50" value="${cat}" checked />
            <span class="truncate">${displayName}</span>
          </label>
        `;
      }).join('');
      
      // Setup select all checkbox
      selectAllCheckbox.checked = true;
      selectAllCheckbox.onchange = () => {
        document.querySelectorAll('.viz-category-checkbox').forEach(cb => {
          cb.checked = selectAllCheckbox.checked;
        });
      };
      
      // Update select all when individual checkboxes change
      categoriesList.addEventListener('change', (e) => {
        if (e.target.classList.contains('viz-category-checkbox')) {
          const allChecked = [...document.querySelectorAll('.viz-category-checkbox')].every(cb => cb.checked);
          const someChecked = [...document.querySelectorAll('.viz-category-checkbox')].some(cb => cb.checked);
          selectAllCheckbox.checked = allChecked;
          selectAllCheckbox.indeterminate = someChecked && !allChecked;
        }
      });
    }

    function getSelectedCategories() {
      const checkboxes = document.querySelectorAll('.viz-category-checkbox:checked');
      return [...checkboxes].map(cb => cb.value);
    }

    function filterCardByCategories(card, selectedCategories) {
      const filtered = {};
      selectedCategories.forEach(cat => {
        if (card[cat] !== undefined) {
          filtered[cat] = card[cat];
        }
      });
      return filtered;
    }

    function buildVisualizationPrompt(card, mode) {
      // Get selected categories
      const selectedCategories = getSelectedCategories();
      const filteredCard = filterCardByCategories(card, selectedCategories);
      
      // Always ensure we have basic context (title) even if metadata is unchecked
      const fullMetadata = card.metadata || {};
      const title = fullMetadata.title || 'Research Synthesis';
      
      // Check if all categories are selected (overview mode) vs focused mode
      const allCategories = Object.keys(card).filter(k => !k.startsWith('_'));
      const isOverviewMode = selectedCategories.length >= allCategories.length - 1; // -1 to allow skipping metadata
      
      let contentSections = [];
      let focusNote = '';
      
      if (isOverviewMode) {
        // OVERVIEW MODE: Extract key highlights only, not everything
        contentSections.push(`TITLE: "${title}"`);
        contentSections.push(`\nüìå KEY HIGHLIGHTS FOR OVERVIEW:`);
        
        // Extract just the essential elements from each category
        selectedCategories.forEach(category => {
          const data = filteredCard[category];
          if (!data) return;
          
          const categoryLabel = categoryDisplayNames[category]?.replace(/^[^\s]+\s*/, '') || category.replace(/_/g, ' ').toUpperCase();
          const summary = extractCategorySummary(category, data);
          if (summary) {
            contentSections.push(`\n‚Ä¢ ${categoryLabel}: ${summary}`);
          }
        });
        
        focusNote = `\n\nüéØ OVERVIEW MODE:
Create a holistic visualization showing the main themes and their relationships.
- Show the big picture, not every detail
- Highlight 5-8 key concepts maximum
- Emphasize connections between major themes
- Use visual hierarchy to show importance`;
        
      } else {
        // FOCUSED MODE: Extract detailed content for selected categories only
        contentSections.push(`TITLE: "${title}"`);
        
        // Process each selected category and extract ALL its content deeply
        selectedCategories.forEach(category => {
          const data = filteredCard[category];
          if (!data) return;
          
          const categoryLabel = categoryDisplayNames[category]?.replace(/^[^\s]+\s*/, '') || category.replace(/_/g, ' ').toUpperCase();
          const extractedContent = extractCategoryContent(category, data);
          if (extractedContent) {
            contentSections.push(`\n=== ${categoryLabel} ===\n${extractedContent}`);
          }
        });
        
        const selectedNames = selectedCategories.map(c => 
          categoryDisplayNames[c]?.replace(/^[^\s]+\s*/, '') || c.replace(/_/g, ' ')
        ).join(', ');
        focusNote = `\n\n‚ö†Ô∏è CRITICAL FOCUS INSTRUCTION ‚ö†Ô∏è
This visualization MUST represent ONLY these specific aspects: ${selectedNames}.
- Do NOT include a general overview of the paper/research
- Do NOT add content that is not explicitly in the sections above
- Every visual element must directly correspond to the content provided above
- Show ALL the details provided for these specific categories
- The goal is a focused, detailed visualization of JUST the selected content`;
      }
      
      const contentBlock = contentSections.join('\n');
      
      let prompt = '';
      
      switch (mode) {
        case 'schematic':
          prompt = `Create a visually striking conceptual diagram that maps the relationships between ideas from the content below.

${contentBlock}${focusNote}

STYLE REQUIREMENTS:
- Beautiful, modern scientific illustration style
- Flowing connections between concepts using elegant curved lines and arrows
- Use varied geometric shapes (circles, hexagons, rounded rectangles) for different concept types
- Rich but harmonious color palette with gradients and subtle glows
- Visual hierarchy: larger/brighter elements for central concepts
- Connections should show directionality and relationship types through line styles (solid, dashed, varying thickness)
- Minimal text: only key concept names as short labels (1-3 words each)
- Add small icons or symbols to represent concept categories
- Soft shadows and depth to create visual interest
- Clean composition with breathing room between elements
- Light or gradient background that complements the color scheme
- Inspired by modern data visualization and concept mapping aesthetics`;
          break;
          
        case 'intuitive':
          prompt = `Create an artistic, metaphorical visualization with embedded text representing ONLY the specific content below.

${contentBlock}${focusNote}

STYLE REQUIREMENTS:
- Dreamlike, evocative imagery blended with concept mapping
- IMPORTANT: Include floating text labels for key concepts FROM THE CONTENT ABOVE ONLY
- Integrate words organically into the composition
- Add handwritten-style annotations connecting ideas
- Rich colors and organic forms
- Abstract but meaningful composition with labeled regions
- Blend scientific and artistic aesthetics
- Create emotional resonance while maintaining clarity
- Like an illustrated mind map or annotated art piece`;
          break;
          
        case 'network':
          prompt = `Create a node-link network diagram visualizing ONLY the connections from the specific content below.

${contentBlock}${focusNote}

STYLE REQUIREMENTS:
- Force-directed network layout
- Colored nodes by category/type
- Varying edge thickness for importance
- IMPORTANT: Clear text labels on ALL nodes with concept names FROM THE CONTENT ABOVE ONLY
- Label edges with relationship types
- Include a legend explaining node colors
- Dark background with glowing nodes
- Data visualization aesthetic`;
          break;
          
        case 'infographic':
          prompt = `Create a data-rich infographic poster representing ONLY the specific content below.

${contentBlock}${focusNote}

STYLE REQUIREMENTS:
- Modern infographic design
- IMPORTANT: Include clear readable text for all sections FROM THE CONTENT ABOVE ONLY
- Bold title at top
- Icons paired with descriptive text labels
- Organized sections with clear hierarchy and headings
- Data visualization elements with axis labels
- Bold typography for headings, readable body text
- Cohesive color scheme
- Magazine or poster quality with emphasis on readability`;
          break;
      }
      
      return prompt;
    }

    // Helper function to extract a brief summary of a category (for overview mode)
    function extractCategorySummary(category, data) {
      if (!data) return '';
      
      // Handle arrays - just get first 2-3 items briefly
      if (Array.isArray(data)) {
        const items = data.slice(0, 3).map(item => {
          if (typeof item === 'string') return item.substring(0, 80);
          if (typeof item === 'object') {
            return item.name || item.title || item.description?.substring(0, 80) || '';
          }
          return '';
        }).filter(Boolean);
        return items.join('; ');
      }
      
      // Handle objects - extract the most important field
      if (typeof data === 'object') {
        // Priority fields to look for
        const priorityFields = ['description', 'summary', 'main_question', 'core_claim', 
                                'central_claim', 'thesis', 'claim', 'definition', 'overview'];
        
        // First, try to find a summary/description field
        for (const field of priorityFields) {
          if (data[field] && typeof data[field] === 'string') {
            return data[field].substring(0, 150);
          }
        }
        
        // Otherwise, collect key themes from nested objects
        const themes = [];
        Object.entries(data).forEach(([key, value]) => {
          if (key === 'citations_or_quotes' || key.startsWith('_')) return;
          
          if (typeof value === 'string' && value.length > 10 && value.length < 200) {
            themes.push(value.substring(0, 60));
          } else if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
            // Look for description in nested object
            if (value.description) {
              themes.push(value.description.substring(0, 60));
            } else if (value.name || value.title) {
              themes.push(value.name || value.title);
            }
          } else if (Array.isArray(value) && value.length > 0) {
            // Get first item from array
            const first = value[0];
            if (typeof first === 'string') {
              themes.push(first.substring(0, 50));
            } else if (first?.name || first?.description) {
              themes.push((first.name || first.description).substring(0, 50));
            }
          }
          
          if (themes.length >= 3) return; // Limit to 3 themes
        });
        
        return themes.slice(0, 3).join('; ');
      }
      
      // Handle simple strings
      if (typeof data === 'string') {
        return data.substring(0, 150);
      }
      
      return '';
    }

    // Helper function to deeply extract content from a category (for focused mode)
    function extractCategoryContent(category, data) {
      if (!data) return '';
      
      let lines = [];
      
      // Handle arrays directly
      if (Array.isArray(data)) {
        data.slice(0, 8).forEach(item => {
          if (typeof item === 'string') {
            lines.push(`‚Ä¢ ${item}`);
          } else if (typeof item === 'object') {
            const desc = item.description || item.name || item.title || item.central_claim || JSON.stringify(item);
            lines.push(`‚Ä¢ ${desc}`);
          }
        });
        return lines.join('\n');
      }
      
      // Handle objects - iterate through all keys with smart extraction
      if (typeof data === 'object') {
        Object.entries(data).forEach(([key, value]) => {
          // Skip citation fields and internal fields
          if (key === 'citations_or_quotes' || key.startsWith('_')) return;
          
          const label = key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
          
          // Handle strings
          if (typeof value === 'string' && value.trim()) {
            lines.push(`${label}: ${value}`);
          } 
          // Handle boolean with suggested/true pattern
          else if (typeof value === 'boolean') {
            if (value) lines.push(`${label}: Yes`);
          }
          // Handle arrays
          else if (Array.isArray(value) && value.length > 0) {
            lines.push(`${label}:`);
            value.slice(0, 8).forEach(item => {
              if (typeof item === 'string') {
                lines.push(`  ‚Ä¢ ${item}`);
              } else if (typeof item === 'object') {
                // Handle complex items with multiple potential text fields
                const desc = item.description || item.name || item.title || item.claim || item.central_claim || '';
                const examples = item.examples ? ` (e.g., ${item.examples.slice(0,3).join(', ')})` : '';
                if (desc) {
                  lines.push(`  ‚Ä¢ ${desc}${examples}`);
                } else {
                  // Fallback: extract first string field
                  const firstString = Object.values(item).find(v => typeof v === 'string' && v.length > 10);
                  if (firstString) lines.push(`  ‚Ä¢ ${firstString.substring(0, 200)}`);
                }
              }
            });
          } 
          // Handle nested objects (2nd level)
          else if (typeof value === 'object' && value !== null) {
            const nestedContent = [];
            Object.entries(value).forEach(([nestedKey, nestedVal]) => {
              if (nestedKey === 'citations_or_quotes' || nestedKey.startsWith('_')) return;
              const nestedLabel = nestedKey.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
              
              if (typeof nestedVal === 'string' && nestedVal.trim()) {
                nestedContent.push(`  ${nestedLabel}: ${nestedVal}`);
              } else if (typeof nestedVal === 'boolean' && nestedVal) {
                nestedContent.push(`  ${nestedLabel}: Yes`);
              } else if (Array.isArray(nestedVal) && nestedVal.length > 0) {
                nestedContent.push(`  ${nestedLabel}:`);
                nestedVal.slice(0, 6).forEach(item => {
                  if (typeof item === 'string') {
                    nestedContent.push(`    ‚Ä¢ ${item}`);
                  } else if (typeof item === 'object') {
                    const desc = item.description || item.name || item.title || '';
                    if (desc) nestedContent.push(`    ‚Ä¢ ${desc}`);
                  }
                });
              }
              // Handle 3rd level nested objects
              else if (typeof nestedVal === 'object' && nestedVal !== null) {
                const thirdLevel = [];
                Object.entries(nestedVal).forEach(([thirdKey, thirdVal]) => {
                  if (thirdKey === 'citations_or_quotes') return;
                  const thirdLabel = thirdKey.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                  if (typeof thirdVal === 'string' && thirdVal.trim()) {
                    thirdLevel.push(`    ${thirdLabel}: ${thirdVal}`);
                  } else if (Array.isArray(thirdVal) && thirdVal.length > 0) {
                    thirdLevel.push(`    ${thirdLabel}: ${thirdVal.slice(0,4).map(i => typeof i === 'string' ? i : i.description || i.name || '').filter(Boolean).join('; ')}`);
                  }
                });
                if (thirdLevel.length > 0) {
                  nestedContent.push(`  ${nestedLabel}:`);
                  nestedContent.push(...thirdLevel);
                }
              }
            });
            if (nestedContent.length > 0) {
              lines.push(`${label}:`);
              lines.push(...nestedContent);
            }
          }
        });
      }
      
      return lines.join('\n');
    }

    async function generateVisualization() {
      const apiKey = $("viz-api-key").value.trim();
      const status = $("viz-status");
      const btn = $("btn-generate-viz");
      
      if (!apiKey) {
        status.innerHTML = '<span class="text-yellow-400">Please enter your Google AI API key</span>';
        return;
      }
      
      if (!loadedCardData) {
        status.innerHTML = '<span class="text-yellow-400">Please load a card first</span>';
        return;
      }
      
      const mode = $("viz-mode-value").value || 'schematic';
      const model = $("viz-model-value").value || 'gemini-2.5-flash-preview-05-20';
      
      // Build the prompt
      generatedPrompt = buildVisualizationPrompt(loadedCardData, mode);
      
      status.innerHTML = '<span class="text-accentCyan animate-pulse">Generating visualization...</span>';
      btn.disabled = true;
      btn.classList.add("opacity-50", "cursor-wait");
      
      try {
        const result = await apiGenerateVision(apiKey, generatedPrompt, model);
        
        if (result.success && result.imageData) {
          generatedImageData = result.imageData;
          $("viz-result-image").src = result.imageData;
          $("viz-prompt-display").textContent = generatedPrompt;
          $("viz-result-container").classList.remove("hidden");
          status.innerHTML = '<span class="text-green-400">‚úì Visualization generated successfully!</span>';
        } else {
          status.innerHTML = `<span class="text-red-400">‚úó ${result.error || 'Failed to generate image'}</span>`;
        }
      } catch (err) {
        console.error("Visualization error:", err);
        status.innerHTML = `<span class="text-red-400">‚úó Error: ${err.message}</span>`;
      } finally {
        btn.disabled = false;
        btn.classList.remove("opacity-50", "cursor-wait");
      }
    }

    async function apiGenerateVision(apiKey, prompt, model) {
      const response = await fetch(`${API_BASE}/generate_vision`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ apiKey, prompt, model })
      });
      return await response.json();
    }

    function downloadVisualization() {
      if (!generatedImageData) return;
      
      const link = document.createElement('a');
      link.href = generatedImageData;
      link.download = `knowledge-card-viz-${Date.now()}.png`;
      link.click();
    }
  </script>

</body>
</html>
